---
title: "Trust-level Covid-19 hospital admissions forecasts"
author: "Sophie Meakin, Sam Abbott, Seb Funk"
date: "`r format.Date(Sys.Date(), format = '%d %B %Y')`"
output:
  html_document:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE,
                      fig.width = 14, fig.height = 9)

library(tidyverse)
library(ggrepel)
library(patchwork)
library(covidregionaldata)
library(covid19.nhs.data)

source(here::here("R", "load_data_fns.R"))
source(here::here("R", "plot_fns.R"))
source(here::here("R", "utils.R"))

forecast_date <- as.Date("2021-07-04")

```

```{r new variables, include = FALSE}

flag_utlas <- readRDS(file = here::here("current_forecasts", "data", "flag_utla.rds"))
exclude_utlas <- flag_utlas$id_name

manual_remove <- tibble::tibble(trust_code = c("R1H", "RF4", "RQX"), trust_name = NA, n = NA, utla_names = NA, label = NA)

exclude_trusts <- covid19.nhs.data::trust_utla_mapping %>%
  covid19.nhs.data::get_names() %>%
  dplyr::filter(geo_name %in% exclude_utlas,
                p_geo > 0.2) %>%
  dplyr::group_by(trust_code, trust_name) %>%
  dplyr::summarise(n = n(),
                   utla_names = paste(geo_name, collapse = ", ")) %>%
  dplyr::mutate(label = ifelse(n == 1,
                               paste0(trust_name, " (UTLA: ", utla_names, ")" ),
                               paste0(trust_name, " (UTLAs: ", utla_names, ")" ))) %>%
  dplyr::bind_rows(manual_remove)

```

```{r observed, include = FALSE}

admissions <- load_hospital_data(keep_data = c("all_adm"), add_private = TRUE) %>%
  dplyr::rename(adm = all_adm) %>%
  dplyr::left_join(covid19.nhs.data::trust_names, by = c("id" = "trust_code")) %>%
  dplyr::mutate(trust_name = stringr::str_wrap(trust_name, width = 40)) %>%
  dplyr::filter(!id %in% exclude_trusts$trust_code)

plot_trusts_observed <- admissions %>%
  dplyr::filter(date > forecast_date - 28,
                date <= forecast_date) %>%
  dplyr::group_by(id) %>%
  dplyr::summarise(total_adm = sum(adm, na.rm = TRUE)) %>%
  dplyr::arrange(-total_adm) %>%
  dplyr::slice_head(n = 25) %>%
  dplyr::pull(id)

 trusts_observed7 <- admissions %>%
  dplyr::filter(date > forecast_date - 7,
                date <= forecast_date) %>%
  dplyr::group_by(nhs_region, id) %>%
  dplyr::summarise(observed = mean(adm, na.rm = TRUE))

```

# Summary

The current forecast date is **`r format.Date(forecast_date, format = "%d %B")`**, showing data until **`r format.Date(max(admissions$date, na.rm = TRUE), format = "%d %B")`**.

**`r ifelse(length(exclude_trusts$label)>0, "The following Trusts/UTLAs have been temporarily excluded from this report due issues with the underlying case forecasts in one or more associated UTLAs:", "")`** `r paste0(exclude_trusts$label, collapse = ", ")`

The main forecasting model is an unweighted ensemble of three individual models:

1. unweighted time series ensemble model (autoregressive ARIMA, ETS and naive models)
2. regression + 7-day-lagged cases (cases mapped from UTLA to Trust using Trust-UTLA mapping in `covid19.nhs.data`)
3. convolution from cases to admissions (scaled; cases mapped to Trusts as above)

All models are trained on the last 6 weeks of data (from `r format.Date(forecast_date - 42, format = "%d %B")`) and forecasts are made for the following 14 days.


```{r load forecasts}

# Current forecast summary
current_forecast <- readRDS(file = here::here("current_forecasts",
                                              "data",
                                              "admissions_trust",
                                              paste0("admissions_", forecast_date, ".rds"))) %>%
  dplyr::select(-quantile) %>%
  tidyr::pivot_wider(id_cols = -c(quantile_label, value), names_from = quantile_label) %>%
  dplyr::select(forecast_from, model, id, date = date_horizon, horizon,
                median = lower_0, lower_90, lower_50, upper_50, upper_90) %>%
  dplyr::filter(horizon <= 14) %>%
  dplyr::left_join(covid19.nhs.data::trust_names, by = c("id" = "trust_code")) %>%
  dplyr::mutate(trust_name = stringr::str_wrap(trust_name, width = 40)) %>%
  dplyr::filter(!id %in% exclude_trusts$trust_code)

# Current forecast samples
current_forecast_long <- readRDS(file = here::here("current_forecasts",
                                                   "data",
                                              "admissions_trust",
                                              paste0("admissions_long_", forecast_date, ".rds")))

# All past forecasts
file_dir <- here::here("current_forecasts", "data", "admissions_trust")
file_names <- list.files(file_dir)[which(!grepl("latest", list.files(file_dir)) &
                                           !grepl("long", list.files(file_dir)) &
                                           !grepl(forecast_date, list.files(file_dir)))]
all_forecasts <- purrr::map_df(.x = file_names, .f = ~ {
  
  out <- readRDS(file = here::here(file_dir, .x))
  return(out)
  
}) %>%
  dplyr::bind_rows() %>%
  dplyr::select(-quantile) %>%
  tidyr::pivot_wider(id_cols = -c(quantile_label, value), names_from = quantile_label) %>%
  dplyr::select(forecast_from, model, id, date = date_horizon, horizon,
                median = lower_0, lower_90, lower_50, upper_50, upper_90) %>%
  dplyr::left_join(covid19.nhs.data::trust_names, by = c("id" = "trust_code")) %>%
  dplyr::mutate(trust_name = stringr::str_wrap(trust_name, width = 40))


# 7- and 14-day median forecast + current 7-day average
forecast_point <- current_forecast %>%
  dplyr::filter(model == "mean_ensemble",
                horizon %in% c(7, 14)) %>%
  dplyr::select(id, horizon, median) %>%
  dplyr::mutate(horizon = paste0("forecast_", horizon)) %>%
  tidyr::pivot_wider(id_cols = id, names_from = horizon, values_from = median) %>%
  dplyr::left_join(trusts_observed7, by = "id") %>%
  dplyr::left_join(covid19.nhs.data::trust_names, by = c("id" = "trust_code")) %>%
  dplyr::select(nhs_region, id, trust_name, observed, forecast_7, forecast_14)

# 7- and 14-day probability of increase
forecast_prob <- current_forecast_long %>%
  dplyr::filter(model == "mean_ensemble",
                horizon %in% c(7, 14)) %>%
  dplyr::left_join(trusts_observed7, by = c("id")) %>%
  dplyr::mutate(observed = round(observed)) %>%
  dplyr::group_by(forecast_from, id, horizon) %>%
  dplyr::filter(value > observed) %>%
  dplyr::group_by(forecast_from, id, horizon) %>%
  dplyr::filter(quantile == min(quantile)) %>%
  dplyr::mutate(horizon = paste0("p_", horizon),
                p_increase = 1-quantile) %>%
  dplyr::ungroup() %>%
  dplyr::select(id, horizon, p_increase) %>%
  unique() %>%
  tidyr::pivot_wider(id_cols = -c(horizon, p_increase), names_from = horizon, values_from = p_increase) %>%
  dplyr::filter(!id %in% exclude_trusts$trust_code)

# Current forecast summary table
current_forecast_tb <- forecast_point %>%
  dplyr::left_join(forecast_prob, by = "id") %>%
  dplyr::select(nhs_region, id, trust_name, observed, forecast_7, p_7, forecast_14, p_14) %>%
  dplyr::mutate(observed = round(observed, 1),
                p_7 = round(p_7, 2),
                p_14 = round(p_14, 2))

# Data for scatter plot
scatter_data <- current_forecast_tb %>%
  dplyr::ungroup() %>%
  dplyr::mutate(change = forecast_14 - observed,
                label = ifelse(observed >= 1 & (observed > quantile(observed, 0.9, na.rm = TRUE) |
                                 p_14 > quantile(p_14, 0.9, na.rm = TRUE) |
                                 p_14 == 0.99),
                               trust_name, NA),
                label = stringr::str_wrap(label, width = 25))

```

```{r include = FALSE}

return_region_plots <- function(region = "North West"){
  
  tb_summary <- DT::datatable(data = current_forecast_tb %>%
                                dplyr::filter(nhs_region == region) %>%
                dplyr::select(`NHS region` = nhs_region,
                              ID = id,
                              Name = trust_name,
                              `Current 7-day average` = observed,
                              `One-week ahead forecast` = forecast_7,
                              `Two-weeks ahead forecast` = forecast_14,
                              `14-day probability of increase` = p_14),
              rownames = FALSE,
              )
  
  g_current <- plot_forecast_ribbons(observed = admissions %>%
                        dplyr::filter(date > forecast_date - 21,
                                      date <= forecast_date) %>%
                        dplyr::rename(observed = adm),
                      forecast = current_forecast,
                     trusts = unique(current_forecast_tb$id[which(current_forecast_tb$nhs_region == region & current_forecast_tb$observed >= 0.7)]),
                     models = "mean_ensemble",
                     facet_models = FALSE) +
  scale_x_date(breaks = "1 weeks", date_labels = "%d %b") +
  scale_y_continuous(breaks = integer_breaks(), limits = c(0, NA)) +
  labs(title = region,
       subtitle = "Ensemble model",
       caption = paste0("Forecasts from ", format.Date(forecast_date, format = "%d %B %Y"))) +
  theme(legend.position = "none", strip.text.x = element_text(size = 8)) +
  ## Adding current observed data
  geom_line(data = admissions %>%
                        dplyr::filter(nhs_region == region,
                                      id %in% unique(current_forecast_tb$id[which(current_forecast_tb$nhs_region == region & current_forecast_tb$observed >= 0.7)]),
                                      date >= forecast_date) %>%
                        dplyr::rename(observed = adm),
            aes(x = date, y = observed))
  
  g_current_conv <- plot_forecast_ribbons(observed = admissions %>%
                          dplyr::filter(date > forecast_date - 21,
                                        date <= forecast_date) %>%
                          dplyr::rename(observed = adm),
                        forecast = current_forecast,
                       trusts = unique(current_forecast_tb$id[which(current_forecast_tb$nhs_region == region & current_forecast_tb$observed >= 0.7)]),
                       models = "convolution_rt",
                       facet_models = FALSE) +
    scale_x_date(breaks = "1 weeks", date_labels = "%d %b") +
    scale_y_continuous(breaks = integer_breaks(), limits = c(0, NA)) +
    scale_color_brewer(palette = "Set1") +
    scale_fill_brewer(palette = "Set1") +
    labs(title = region,
         subtitle = "Case-convolution model",
         caption = paste0("Forecasts from ", format.Date(forecast_date, format = "%d %B %Y"))) +
    theme(legend.position = "none", strip.text.x = element_text(size = 8)) +
    ## Adding current observed data
    geom_line(data = admissions %>%
                          dplyr::filter(nhs_region == region,
                                        id %in% unique(current_forecast_tb$id[which(current_forecast_tb$nhs_region == region & current_forecast_tb$observed >= 0.7)]),
                                        date >= forecast_date) %>%
                          dplyr::rename(observed = adm),
              aes(x = date, y = observed))
  
  g_scatter <- scatter_data %>%
    ggplot(aes(x = p_14, y = observed)) +
    geom_point(size = 3, col = "grey90") +
    geom_text_repel(data = scatter_data %>%
                      dplyr::filter(nhs_region == region),
                    aes(label = label),
                    size = 3, col = "grey20",
                    point.padding = 0.2, min.segment.length = 0.1) +
    scale_x_continuous(limits = c(0, 1)) +
    scale_y_continuous(limits = c(0, NA), breaks = seq(0, 20, 2)) +
    scale_color_fermenter(n.breaks = 7, palette = "RdBu", limits = max(abs(scatter_data$change))*c(-1, 1)) +
    labs(x = "Probability of increase (14 days ahead)", y = "Current admissions (7-day average)",
         title = region,
         subtitle = "Ensemble model",
         caption = paste0("Forecasts from ", format.Date(forecast_date, format = "%d %B %Y")),
         col = "Forecast\nchange") +
    theme_bw()
  g_scatter <- g_scatter +
    geom_point(data = scatter_data %>%
                 dplyr::filter(nhs_region == region),
               aes(col = change), size = 3)
  
  g_past7 <- plot_forecast_bars(observed = admissions %>%
                         dplyr::filter(date >= forecast_date - 84) %>%
                         dplyr::rename(observed = adm),
                     forecast = all_forecasts,
                     h = 7,
                     trusts = unique(admissions$id[which(admissions$nhs_region == region)]),
                     models = "mean_ensemble",
                     facet_models = FALSE) +
    scale_x_date(limits = c(forecast_date - 63, forecast_date + 1),
                 breaks = "2 weeks", date_labels = "%d %b") +
    scale_y_continuous(limits = c(0, NA), breaks = integer_breaks()) +
    labs(title = region,
         subtitle = "7-day ahead forecasts, ensemble model") +
    theme(legend.position = "none")

  g_past14 <- plot_forecast_bars(observed = admissions %>%
                         dplyr::filter(date >= forecast_date - 84) %>%
                         dplyr::rename(observed = adm),
                     forecast = all_forecasts,
                     h = 14,
                     trusts = unique(admissions$id[which(admissions$nhs_region == region)]),
                     models = "mean_ensemble",
                     facet_models = FALSE) +
    scale_x_date(limits = c(forecast_date - 63, forecast_date + 1),
                 breaks = "2 weeks", date_labels = "%d %b") +
    scale_y_continuous(limits = c(0, NA), breaks = integer_breaks()) +
    labs(title = region,
         subtitle = "14-day ahead forecasts, ensemble model") +
    theme(legend.position = "none")
  
  return(list(table_summary = tb_summary,
              current_forecast = g_current,
              current_forecast_convolution = g_current_conv,
              scatter = g_scatter,
              past_7days = g_past7,
              past_14days = g_past14))
  
}

```

# Current forecast {.tabset}

## Overall {.tabset .tabset-pills}

### Summary, table

```{r overall}

# Table
DT::datatable(data = current_forecast_tb %>%
                dplyr::select(`NHS region` = nhs_region,
                              ID = id,
                              Name = trust_name,
                              `Current 7-day average` = observed,
                              `One-week ahead forecast` = forecast_7,
                              `Two-weeks ahead forecast` = forecast_14,
                              `14-day probability of increase` = p_14),
              rownames = FALSE,
              )

```

### Current forecast, ribbon {.active}

```{r}

plot_forecast_ribbons(observed = admissions %>%
                        dplyr::filter(date > forecast_date - 21,
                                      date <= forecast_date) %>%
                        dplyr::rename(observed = adm),
                      forecast = current_forecast,
                     trusts = plot_trusts_observed,
                     models = "mean_ensemble",
                     facet_models = FALSE) +
  scale_x_date(breaks = "1 weeks", date_labels = "%d %b") +
  scale_y_continuous(breaks = integer_breaks(), limits = c(0, NA)) +
  labs(title = "Top 25 Trusts with most admissions in last 28 days",
       subtitle = "Ensemble model",
       caption = paste0("Forecasts from ", format.Date(forecast_date, format = "%d %B %Y"))) +
  theme(legend.position = "none", strip.text.x = element_text(size = 8)) +
  ## Adding current observed data
  geom_line(data = admissions %>%
                        dplyr::filter(id %in% plot_trusts_observed,
                                      date >= forecast_date) %>%
                        dplyr::rename(observed = adm),
            aes(x = date, y = observed))

```

### Forecast increase, scatter

```{r}

scatter_data %>%
  ggplot(aes(x = p_14, y = observed, col = change)) +
  geom_point(size = 3) +
  geom_text_repel(aes(label = label), size = 3, col = "grey20",
                  point.padding = 0.2, min.segment.length = 0.1) +
  scale_x_continuous(limits = c(0, 1)) +
  scale_y_continuous(limits = c(0, NA), breaks = seq(0, 20, 2)) +
  scale_color_fermenter(n.breaks = 7, palette = "RdBu", limits = max(abs(scatter_data$change))*c(-1, 1)) +
  labs(x = "Probability of increase (14 days ahead)", y = "Current admissions (7-day average)",
       title = paste0("Forecasts from ", format.Date(forecast_date, format = "%d %B %Y")),
       subtitle = "Ensemble model",
       col = "Forecast\nchange") +
  theme_bw()

# Facetted by NHS region
scatter_data %>%
  ggplot(aes(x = p_14, y = observed, col = change)) +
  geom_point(size = 3) +
  geom_text_repel(aes(label = label), size = 3, col = "grey20",
                  point.padding = 0.2, min.segment.length = 0.1) +
  facet_wrap(. ~ nhs_region) +
  scale_x_continuous(limits = c(0, 1)) +
  scale_y_continuous(limits = c(0, NA), breaks = seq(0, 20, 2)) +
  scale_color_fermenter(n.breaks = 7, palette = "RdBu", limits = max(abs(scatter_data$change))*c(-1, 1)) +
  labs(x = "Probability of increase (14 days ahead)", y = "Current admissions (7-day average)",
       title = paste0("Forecasts from ", format.Date(forecast_date, format = "%d %B %Y")),
       subtitle = "Ensemble model",
       col = "Forecast\nchange") +
  theme_bw()

```

### Forecast increase, maps

```{r}

loc <- readRDS(file = here::here("data", "out", "trust_characteristics", "trust_locations.rds"))

loc_sf <- sf::st_as_sf(loc %>% filter(!is.na(lng)), coords = c("lng", "lat"),
                       crs = 4326, agr = "constant", remove = FALSE) %>%
  dplyr::left_join(covid19.nhs.data::trust_names, by = c("id" = "trust_code")) %>%
  dplyr::left_join(current_forecast_tb, by = "id") %>%
  dplyr::filter(!is.na(p_7), !is.na(p_14))

cities <- readr::read_csv(file = "~/Downloads/gb.csv") %>%
  dplyr::filter(!city %in% c("Glasgow")) %>%
  dplyr::slice_head(n = 11) %>%
  dplyr::mutate(label_name = ifelse(city == "Birstall", admin_name, city))

cities_sf <- sf::st_as_sf(cities, coords = c("lng", "lat"), crs = 4326, agr = "constant", remove = FALSE)

# England
covid19.nhs.data::england_utla_shape %>%
  ggplot() +
  geom_sf(lwd = 0.3, col = "grey40", fill = "grey65") +
  # geom_sf(data = cities_sf, col = "grey20", shape = 15, size = 3) +
  geom_sf(data = loc_sf, aes(col = p_14)) +
  geom_sf_text(data = cities_sf, aes(label = label_name)) +
  scale_color_distiller(palette = "PiYG", limits = c(0, 1)) +
  labs(x = "", y = "",
       title = "England",
       col = "Prob. of\nincrease") +
  theme_bw() +
  theme(legend.position = "right")

# London
covid19.nhs.data::england_utla_shape %>%
  ggplot() +
  geom_sf(lwd = 0.3, col = "grey40", fill = "grey65") +
  geom_sf(data = loc_sf, aes(col = p_7), size = 3) +
  coord_sf(xlim = c(-0.5, 0.5), ylim = c(51.3, 51.7), crs = 4326, expand = FALSE) +
  scale_color_distiller(palette = "PiYG", limits = c(0, 1)) +
  labs(x = "", y = "",
       title = "London",
       col = "Prob. of\nincrease") +
  theme_bw() +
  theme(legend.position = "right")

# North West
covid19.nhs.data::england_utla_shape %>%
  ggplot() +
  geom_sf(lwd = 0.3, col = "grey40", fill = "grey65") +
  # geom_sf(data = cities_sf, col = "grey20", shape = 15, size = 3) +
  geom_sf(data = loc_sf, aes(col = p_14), size = 3) +
  geom_sf_text(data = cities_sf, aes(label = label_name)) +
  coord_sf(xlim = c(-3.5, -1), ylim = c(53, 54), crs = 4326, expand = FALSE) +
  scale_color_distiller(palette = "PiYG", limits = c(0, 1)) +
  labs(x = "", y = "",
       title = "North West",
       col = "Prob. of\nincrease") +
  theme_bw() +
  theme(legend.position = "right")

```



## By NHS region {.tabset .tabset-pills}

Note: for clarity, we only show forecasts for Trusts which have admitted five or more patients in the last 7 days.

### East of England

```{r}

plots <- return_region_plots(region = "East of England")

plots$current_forecast
plots$scatter

```

### London

```{r}

plots <- return_region_plots(region = "London")

plots$current_forecast
plots$scatter

```

### Midlands

```{r}

plots <- return_region_plots(region = "Midlands")

plots$current_forecast
plots$scatter

```

### North East and Yorkshire

```{r}

plots <- return_region_plots(region = "North East and Yorkshire")

plots$current_forecast
plots$scatter

```

### North West

```{r}

plots <- return_region_plots(region = "North West")

plots$current_forecast
plots$scatter

```

### South East

```{r}

plots <- return_region_plots(region = "South East")

plots$current_forecast
plots$scatter

```

### South West

```{r}

plots <- return_region_plots(region = "South West")

plots$current_forecast
plots$scatter

```


# Past forecasts

```{r}

plot_forecast_bars(observed = admissions %>%
                       dplyr::filter(date >= forecast_date - 84) %>%
                       dplyr::rename(observed = adm),
                   forecast = all_forecasts,
                   h = 14,
                   trusts = plot_trusts_observed,
                   models = "mean_ensemble",
                   facet_models = FALSE) +
  scale_x_date(limits = c(forecast_date - 63, forecast_date + 1),
               breaks = "2 weeks", date_labels = "%d %b") +
  scale_y_continuous(limits = c(0, NA), breaks = integer_breaks()) +
    labs(title = "Top 25 Trusts with most admissions in last 28 days",
       subtitle = "Past 14-day ahead forecasts, ensemble model") +
  theme(legend.position = "none")

```