---
title: "Introduction"
author: "Sophie Meakin"
date: "01/07/2021"
output: html_document
---

```{r setup, include = FALSE}

knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE,
                      fig.width = 16, fig.height = 9)

fig_text_size <- 14

library(tidyverse)
library(patchwork)
library(covid19.nhs.data)
library(covidregionaldata)

source(here::here("R", "load_data_fns.R"))
source(here::here("R", "plot_fns.R"))
source(here::here("R", "utils.R"))

```

```{r load data}

# Load combined data
dat <- load_combined_data() %>%
  dplyr::filter(date >= as.Date("2020-08-01"),
                date < max(date)) %>%
  dplyr::rename(adm = all_adm, occ = bed_occ) %>%
  dplyr::left_join(covid19.nhs.data::trust_names, by = c("id" = "trust_code"))

# Load admissions forecasts
forecast_dir <- here::here("data", "out", "admissions_forecast", "summary")
forecast_adm_files <- list.files(forecast_dir)[which(grepl("admissions", list.files(forecast_dir)))]

forecast_adm <- purrr::map_df(.x = forecast_adm_files, .f = ~ {
  
  out <- readRDS(file = here::here(forecast_dir, .x))
  
}) %>%
  dplyr::bind_rows() %>%
  dplyr::select(-quantile) %>%
  tidyr::pivot_wider(id_cols = -c(quantile_label, value), names_from = quantile_label)

# Trust characteristics
characteristic_dir <- here::here("data", "out", "trust_characteristics")

trust_size <- readRDS(file = here::here(characteristic_dir, "trust_size.rds"))
total_adm <- readRDS(file = here::here(characteristic_dir, "trust_total.rds"))
trust_mapping <- readRDS(file = here::here(characteristic_dir, "trust_mapping.rds"))
trust_cluster_weekly <- readRDS(file = here::here(characteristic_dir, "trust_cluster_weekly.rds"))
trust_loc <- readRDS(file = here::here(characteristic_dir, "trust_locations.rds"))

# GB cities
cities_raw <- readr::read_csv(file = "~/Downloads/gb.csv")


```

```{r reshape data}

# Weekly observed data (sum cases/admissions, mean occupancy)
dat_weekly <- dat %>%
  dplyr::mutate(week = lubridate::ceiling_date(date, unit = "week", week_start = 7)) %>%
  dplyr::group_by(nhs_region, id, week_ending = week) %>%
  dplyr::summarise(n = n(),
                   cases = sum(cases, na.rm = TRUE),
                   adm = sum(adm, na.rm = TRUE),
                   occ = mean(occ, na.rm = TRUE),
                  .groups = "drop") %>%
  dplyr::filter(n == 7) %>%
  dplyr::select(-n)

# Trust locations
loc_sf <- sf::st_as_sf(trust_loc %>% filter(!is.na(lng)), coords = c("lng", "lat"),
                       crs = 4326, agr = "constant", remove = FALSE) %>%
  dplyr::left_join(covid19.nhs.data::trust_names, by = c("id" = "trust_code"))

# Top-10 cities (England) locations
cities_sf <- cities_raw %>%
  dplyr::filter(!city %in% c("Glasgow")) %>%
  dplyr::slice_head(n = 11) %>%
  dplyr::mutate(label_name = ifelse(city == "Birstall", admin_name, city)) %>%
  sf::st_as_sf(coords = c("lng", "lat"), crs = 4326, agr = "constant", remove = FALSE)

```

```{r define new variables}

# Total admissions
total_admissions <- dat %>%
  dplyr::filter(date < as.Date("2021-02-01")) %>%
  dplyr::group_by(id) %>%
  dplyr::summarise(total_adm = sum(adm, na.rm = TRUE),
                   .groups = "drop")

# Top-x Trusts by total admissions
top_admissions_x <- total_admissions %>%
  dplyr::arrange(-total_adm) %>%
  dplyr::slice_head(n = 40)

# Top-50 Trusts by total admissions
top_admissions_50 <- total_admissions %>%
  dplyr::arrange(-total_adm) %>%
  dplyr::slice_head(n = 50)

# Top-5 Trusts by total admissions
top_admissions_5 <- total_admissions %>%
  dplyr::arrange(-total_adm) %>%
  dplyr::slice_head(n = 5)

plot_dates <- unique(forecast_adm$forecast_from)
long_plot_dates <- seq.Date(from = as.Date("2020-08-02"), to = as.Date("2021-04-04"), by = "week")

```


# Outputs

* Figure 1 (Summary of Covid-19 hospital admissions in England during August 2020 - January 2021)
* Figure S1 (Daily Covid-19 hospital admissions by England NHS region August 2020 - March 2021)
* Figure S2 (Characteristics of acute NHS Trusts in England, August 2020 - January 2021)
* Figure S4 (Example of forecasts generated by the main forecasting models for University Hospitals Birmingham NHS Foundation Trust)


## Figure 1
```{r}

# Admissions at top 5 Trusts (by total admissions)
g_summary_top5 <- dat %>%
  dplyr::filter(id %in% top_admissions_5$id,
                date <= as.Date("2021-02-28")) %>%
  dplyr::mutate(id = ordered(id, top_admissions_5$id),
                facet_label = stringr::str_wrap(paste0(trust_name, " (", id, ")"), width = 40)) %>%
  ggplot(aes(x = date, y = adm)) +
  geom_line() +
  facet_wrap(. ~ facet_label, ncol = 1, scales = "free_y") +
  geom_vline(xintercept = as.Date("2021-01-31"), lty = 2, col = "grey50") +
  geom_vline(xintercept = as.Date("2020-10-04"), lty = 2, col = "grey50") +
  scale_x_date(breaks = long_plot_dates[seq(2, 36, 4)], date_labels = "%d %b") +
  labs(x = "Date", y = "Admissions",
       title = "C") +
  theme_bw() +
  theme(text = element_text(size = fig_text_size),
        strip.text.x = element_text(size = 10))

# National admissions
g_summary_nat <- dat %>%
  dplyr::filter(date <= as.Date("2021-02-28")) %>%
  dplyr::group_by(date) %>%
  dplyr::summarise(adm = sum(adm, na.rm = TRUE)) %>%
  ggplot(aes(x = date, y = adm)) +
  geom_line() +
  geom_vline(xintercept = as.Date("2021-01-31"), lty = 2, col = "grey50") +
  geom_vline(xintercept = as.Date("2020-10-04"), lty = 2, col = "grey50") +
  scale_x_date(breaks = long_plot_dates[seq(2, 36, 4)], date_labels = "%d %b",
               limits = c(as.Date("2020-08-01"), as.Date("2021-03-02"))) +
  labs(x = "", y = "Admissions",
       title = "A") +
  theme_bw() +
  theme(text = element_text(size = fig_text_size))

# Weekly admissions by Trust
g_summary_trust <- dat_weekly %>%
  dplyr::left_join(total_admissions, by = "id") %>%
  dplyr::filter(id %in% top_admissions_x$id,
                week_ending <= as.Date("2021-02-28")) %>%
  dplyr::group_by(id) %>%
  dplyr::mutate(adm_std = adm/sd(adm, na.rm = TRUE)) %>%
  ggplot(aes(x = week_ending, y = reorder(id, total_adm))) +
  geom_tile(aes(fill = adm)) +
  geom_vline(xintercept = as.Date("2021-01-31"), lty = 2) +
  geom_vline(xintercept = as.Date("2020-10-04"), lty = 2) +
  scale_x_date(breaks = long_plot_dates[seq(2, 36, 4)], date_labels = "%d %b",
               limits = c(as.Date("2020-08-01"), NA)) +
  scale_fill_fermenter(n.breaks = 9, direction = 1) +
  labs(x = "Week ending", y = "NHS Trust",
       title = "B",
       fill = "Weekly\nadmissions") +
  theme_bw() +
  theme(text = element_text(size = fig_text_size),
        legend.position = "top",
        legend.key.width = unit(2, 'cm'))

```

```{r figure 1}

(g_summary_nat / g_summary_trust + plot_layout(heights = c(1, 5))) | g_summary_top5

ggsave(filename = here::here("data", "out", "figures", "figure_1.png"),
       width = 14, height = 10, units = "in",
       dpi = 500)

```

### In text values

```{r}

# National weekly admissions at the end of lockdown 3 (02 December 2020)
dat %>%
  dplyr::group_by(date) %>%
  dplyr::summarise(total_admissions = sum(adm, na.rm = TRUE)) %>%
  dplyr::filter(date %in% c(as.Date("2020-12-02"),
                            as.Date("2020-12-09"),
                            as.Date("2020-12-16")))

# National daily peak in admissions
dat %>%
  dplyr::group_by(date) %>%
  dplyr::summarise(total_admissions = sum(adm, na.rm = TRUE)) %>%
  dplyr::filter(total_admissions == max(total_admissions))

```

## Figure S1
```{r}

g_regional <- dat %>%
  dplyr::filter(!is.na(nhs_region)) %>%
  dplyr::group_by(nhs_region, date) %>%
  dplyr::summarise(adm = sum(adm, na.rm = TRUE)) %>%
  dplyr::group_by(nhs_region) %>%
  dplyr::mutate(adm_std = adm/sd(adm),
                adm_trend = (stl(ts(adm, freq = 7), s.window = 7)$time.series)[,2]) %>%
  ggplot(aes(x = date, y = adm_trend, col = nhs_region)) +
  geom_line() +
  geom_line(aes(y = adm), alpha = 0.4) +
  geom_vline(xintercept = as.Date("2021-01-31"), lty = 2) +
  geom_vline(xintercept = as.Date("2020-10-04"), lty = 2) +
  scale_x_date(breaks = long_plot_dates[seq(2, 36, 4)], date_labels = "%d %b %y",
               limits = c(as.Date("2020-08-01"), as.Date("2021-03-02"))) +
  scale_color_brewer(palette = "Set2") +
  labs(x = "Date", y = "Daily admissions",
       col = "NHS region") +
  theme_bw() +
  theme(text = element_text(size = fig_text_size))

```

```{r figure s1}

g_regional

ggsave(filename = here::here("data", "out", "figures", "figure_s1.png"),
       width = 14, height = 8, units = "in",
       dpi = 500)

```


## Figure S2
```{r}

# Additional prep
n_clusters <- 5
cluster_dat <- dat_weekly %>%
  dplyr::left_join(trust_cluster_weekly, by = "id") %>%
  dplyr::mutate(cluster = as.factor(cluster)) %>%
  dplyr::filter(k == n_clusters) %>%
  dplyr::group_by(id) %>%
  dplyr::mutate(adm_std = adm/sd(adm))

# Size of mapping
g_trust_mapping <- trust_mapping %>%
  ggplot() +
  geom_histogram(aes(x = n), binwidth = 1, fill = "lightgrey") +
  geom_histogram(aes(x = n_10), binwidth = 1) +
  scale_x_continuous(breaks = integer_breaks()) +
  labs(x = "Number of matched UTLAs", y = "Count",
       title = "A") +
  theme_bw() +
  theme(text = element_text(size = fig_text_size))

# Bed capacity/total admissions
g_trust_capacity <- trust_size %>%
  dplyr::left_join(total_adm, by = "id") %>%
  ggplot(aes(x = total_bed, y = total_adm)) +
  geom_point(alpha = 0.4) +
  geom_rug(alpha = 0.4) +
  labs(x = "Estimated bed capacity", y = "Total admissions",
       title = "B") +
  theme_bw() +
  theme(text = element_text(size = fig_text_size))

# Trust admissions by cluster
g_trust_admissions <- cluster_dat %>%
  dplyr::mutate(facet = paste0("Cluster ", cluster)) %>%
  dplyr::bind_rows(cluster_dat %>%
                     dplyr::mutate(facet = "All")) %>%
  dplyr::group_by(week_ending, facet, cluster) %>%
  dplyr::mutate(median_adm = mean(adm)) %>%
  dplyr::ungroup() %>%
  dplyr::mutate(adm = ifelse(facet == "All", NA, adm)) %>%
  ggplot(aes(x = week_ending, y = adm)) +
  geom_line(aes(group = id), col = "lightgrey", alpha = 0.4) +
  geom_line(aes(y = median_adm, col = cluster), lwd = 0.8) +
  geom_vline(xintercept = as.Date("2021-01-31"), lty = 2, col = "grey50") +
  facet_wrap(. ~ facet, scales = "free_y") +
  scale_x_date(breaks = long_plot_dates[seq(2, 36, 8)], date_labels = "%d %b",
               limits = c(as.Date("2020-08-01"), as.Date("2021-02-14"))) +
  scale_color_brewer(palette = "Set2", na.value = "grey50") +
  labs(x = "Week ending", y = "Weekly admissions",
       title = "C") +
  theme_bw() +
  theme(legend.position = "none") +
  theme(text = element_text(size = fig_text_size))

# Trust location by cluster
g_trust_locations <- covid19.nhs.data::england_utla_shape %>%
  ggplot() +
  geom_sf(lwd = 0.3, col = "grey60", fill = "white") +
  geom_sf(data = loc_sf %>%
            dplyr::left_join(trust_cluster_weekly, by = "id") %>%
            dplyr::mutate(cluster = as.factor(cluster)) %>%
            dplyr::filter(k == n_clusters | is.na(k)),
          aes(col = cluster), size = 2) +
  geom_sf_text(data = cities_sf, aes(label = label_name)) +
  scale_color_brewer(palette = "Set2", na.value = "grey50") +
  labs(x = "", y = "", col = paste0("Cluster ID (", n_clusters, ")"),
       title = "D") +
  theme_bw() +
  theme(legend.position = "none") +
  theme(text = element_text(size = fig_text_size))

```

```{r figure s2}

((g_trust_mapping | g_trust_capacity) / g_trust_admissions + plot_layout(heights = c(1, 3))) | g_trust_locations

ggsave(filename = here::here("data", "out", "figures", "figure_s2.png"),
       width = 14, height = 8, units = "in",
       dpi = 500)

```

### In-text values
```{r, echo = TRUE}

# Trust mapping summary, no threshold
summary(trust_mapping$n)

# Trust mapping summary, 10% threshold
summary(trust_mapping$n_10)

# Bed capacity summary
summary(trust_size$total_bed)

# Total admissions summary
summary(total_adm$total_adm)

# Capacity/admissions correlation
trust_size %>%
  dplyr::left_join(total_adm, by = "id") %>%
  with(cor(total_bed, total_adm))

```


## Figure S4
```{r}

main_models <- c("snaive",
                 "ts_ensemble_aez",
                 "arima_case7_forecast_raw",
                 "convolution_rt",
                 "median_ensemble_forecast")
main_model_labels <- c("Baseline",
                       "Time series\nensemble",
                       "ARIMA\nregression",
                       "Convolution",
                       "Median\nensemble")
tb_main <- tibble::tibble(model = main_models, label = main_model_labels)

# Additional prep
observed_in <- dat %>%
  dplyr::select(id, date, observed = adm) %>%
  dplyr::left_join(covid19.nhs.data::trust_names, by = c("id" = "trust_code")) %>%
  dplyr::filter(date >= as.Date("2020-09-01"),
                date < as.Date("2021-02-14"))
forecast_in <- forecast_adm %>%
  dplyr::rename(date = date_horizon, median = lower_0) %>%
  dplyr::left_join(covid19.nhs.data::trust_names, by = c("id" = "trust_code")) %>%
  dplyr::left_join(tb_main, by = "model") %>%
  dplyr::ungroup() %>%
  dplyr::filter(!is.na(label)) %>%
  dplyr::select(-model) %>%
  dplyr::rename(model = label)

# Ribbons (all horizons)
g_example_ribbon <- plot_forecast_ribbons(observed = observed_in,
                      forecast = forecast_in,
                      trusts = "R0A",
                      forecast_dates = plot_dates[13],
                      models = setdiff(main_model_labels, "Baseline"),
                      facet_models = TRUE) +
  scale_x_date(breaks = plot_dates[seq(2, 18, 4)], date_labels = "%d %b %y",
               limits = c(as.Date("2020-10-01"), as.Date("2021-02-01"))) +
  labs(title = "A") +
  theme(text = element_text(size = fig_text_size))

# Bars (fixed horizon)
g_example_bar <- plot_forecast_bars(observed = observed_in,
                   forecast = forecast_in,
                   trusts = "R0A",
                   use_dates = plot_dates[seq(1, 18, 2)],
                   models = setdiff(main_model_labels, "Baseline"),
                   h = 7) +
  scale_x_date(breaks = plot_dates[seq(2, 18, 4)], date_labels = "%d %b %y",
               limits = c(as.Date("2020-10-01"), as.Date("2021-02-01"))) +
  scale_y_continuous(limits = c(0, 80)) +
  labs(title = "B") +
  theme(text = element_text(size = fig_text_size))

```

```{r figure s4}

g_example_ribbon | g_example_bar

ggsave(filename = here::here("data", "out", "figures", "figure_s4.png"),
       width = 14, height = 8, units = "in",
       dpi = 500)

```
