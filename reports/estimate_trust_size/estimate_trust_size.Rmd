---
title: "Quantifying the size of NHS Trusts"
author: "Sophie Meakin"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE)

```

# Summary

Since we are, apparently, without any good estimates of the overall bed capacity of Trusts or hospitals, this report sets out to consider any data available to us, namely the Adult G&A bed occupancy data.

* Time window: since 01 January 2021.
* Calculate estimated daily beds as: `Adult G&A Beds Occupied COVID` + `Adult G&A Bed Occupied NonCOVID` + `Adult G&A Beds Unoccupied`.
* Remove outlier values (below 90% or above 110% of the mean estimated daily beds)
* Estimate beds available as the mean of the remaining values, rounded to the nearest integer.

```{r load data}

raw_data <- covid19.nhs.data::download_trust_data()

```

## Bed occupancy estimates

```{r occupancy estimate}

occ_data <- raw_data %>%
  dplyr::mutate(date = date + 108,
                data = case_when(data == "Adult G&A Beds Occupied COVID" ~ "occ_covid",
                                 data == "Adult G&A Bed Occupied NonCOVID" ~ "occ_other",
                                 data == "Adult G&A Beds Unoccupied" ~ "unocc")) %>%
  dplyr::filter(!is.na(data)) %>%
  tidyr::pivot_wider(id_cols = -c(data, value), names_from = data) %>%
  dplyr::mutate(occ_est = occ_covid + occ_other + unocc) %>%
  dplyr::select(nhs_region, trust_code = org_code, date, contains("occ")) %>%
  dplyr::right_join(covid19.nhs.data::trust_ltla_mapping %>%
                      covid19.nhs.data::get_names() %>%
                      dplyr::select(trust_code, trust_name) %>%
                      unique(),
                    by = "trust_code")

beds <- occ_data %>%
  dplyr::filter(date >= as.Date("2021-01-01")) %>%
  dplyr::group_by(nhs_region, trust_code, trust_name) %>%
  dplyr::mutate(occ_est = ifelse(occ_est > 0.9*mean(occ_est, na.rm = TRUE) & occ_est < 1.1*mean(occ_est, na.rm = TRUE),
                                 occ_est, NA)) %>%
  dplyr::group_by(nhs_region, trust_code, trust_name) %>%
  dplyr::summarise(beds = round(mean(occ_est, na.rm = TRUE)))

saveRDS(object = beds, file = here::here("data", "trust", "beds_available.rds"))

```


