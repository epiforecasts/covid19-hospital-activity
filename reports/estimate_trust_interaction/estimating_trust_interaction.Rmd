---
title: "Estimating the interaction between Trusts for a hhh4-type model"
author: "Sophie Meakin"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

library(tidyverse)

```

# Summary

Need to define `w_{ij}` spatial interaction terms in `hhh4`-type model

# Method(s)

## Admissions from shared LTLA

(1) `w_{ij} = 1` if Trusts `i` and `j` share at least one LTLA in the Trust-LTLA admissions mapping, and `0` otherwise.
(2) `w_{ij} = n`, where `n` is the number of LTLAs from which Trust `i` and `j` both admit COVID-19 patients.

```{r shared LTLA}

trust_ltla <- covid19.nhs.data::trust_ltla_mapping %>%
  covid19.nhs.data::get_names()

trust_region <- covid19.nhs.data::download_trust_data()

trust_beds <- readRDS(file = here::here("data", "trust", "beds_available.rds"))

trust_info <- trust_ltla %>%
  dplyr::select(trust_code, trust_name) %>%
  unique() %>%
  dplyr::left_join(trust_region %>%
                     dplyr::right_join(trust_ltla %>%
                                         select(trust_code),
                                       by = c("org_code" = "trust_code")) %>%
                     dplyr::select(nhs_region, trust_code = org_code) %>%
                     unique(),
                   by = "trust_code") %>%
  dplyr::left_join(trust_beds %>%
                     dplyr::ungroup() %>%
                     dplyr::select(trust_code, beds),
                   by = "trust_code")

trust_ltla_full <- trust_ltla %>%
  dplyr::select(trust_code, geo_code) %>%
  dplyr::mutate(ind = 1) %>%
  tidyr::complete(geo_code = unique(trust_ltla$geo_code), fill = list(ind = NA))

w <- trust_ltla_full %>%
  dplyr::left_join(trust_ltla_full, by = "geo_code") %>%
  dplyr::filter(trust_code.x != trust_code.y) %>%
  dplyr::mutate(ind = ind.x*ind.y) %>%
  dplyr::group_by(trust_code1 = trust_code.x, trust_code2 = trust_code.y) %>%
  dplyr::summarise(n = sum(ind, na.rm = TRUE)) %>%
  dplyr::mutate(ind = ifelse(n > 0, 1, 0))

saveRDS(object = w, file = here::here("data", "trust", "trust_interaction.rds"))


```


### Unweighted degree distribution

```{r unweighted}

w %>%
  dplyr::filter(ind == 1) %>%
  dplyr::group_by(trust_code = trust_code1) %>%
  dplyr::summarise(n_edges = n()) %>%
  ggplot(aes(x = n_edges)) +
  geom_histogram(binwidth = 1) +
  labs(x = "Degree",
       title = "Unweighted degree distribution") +
  theme_bw()

w %>%
  dplyr::filter(ind == 1) %>%
  dplyr::group_by(trust_code = trust_code1) %>%
  dplyr::summarise(w_edges = sum(n)) %>%
  ggplot(aes(x = w_edges)) +
  geom_histogram(binwidth = 1) +
  labs(x = "Weighted degree",
       title = "Weighted degree distribution") +
  theme_bw()

```

Trusts with a higher unweighted degree also tend to have a higher unweighted degree; most extreme effect is seen in London.

```{r weighted}

## All NHS regions
w %>%
  dplyr::filter(ind == 1) %>%
  dplyr::group_by(trust_code = trust_code1) %>%
  dplyr::summarise(n_edges = n(),
                   w_edges = sum(n)) %>%
  dplyr::left_join(trust_info, by = "trust_code") %>%
  ggplot(aes(x = n_edges, y = w_edges, col = nhs_region)) +
  geom_point(position = position_jitter(width = 0.2, height = 0.2)) +
  scale_x_continuous(breaks = seq(0, 40, 2)) +
  scale_y_continuous(breaks = seq(0, 40, 4)) +
  scale_color_brewer(palette = "Set2") +
  labs(x = "Degree", y = "Weighted degree",
       col = "NHS region") +
  theme_bw()

```

There is minimal-to-no effect of (estimated) Trust size on unweighted or weighted degree:

```{r size}

w %>%
  dplyr::filter(ind == 1) %>%
  dplyr::group_by(trust_code = trust_code1) %>%
  dplyr::summarise(n_edges = n(),
                   w_edges = sum(n)) %>%
  dplyr::left_join(trust_info, by = "trust_code") %>%
  ggplot(aes(x = beds, y = n_edges)) +
  geom_point() +
  labs(x = "Estimated capacity", y = "Unweighted degree") +
  theme_bw()

w %>%
  dplyr::filter(ind == 1) %>%
  dplyr::group_by(trust_code = trust_code1) %>%
  dplyr::summarise(n_edges = n(),
                   w_edges = sum(n)) %>%
  dplyr::left_join(trust_info, by = "trust_code") %>%
  ggplot(aes(x = beds, y = w_edges)) +
  geom_point() +
  labs(x = "Estimated capacity", y = "Weighted degree") +
  theme_bw()

```





```{r vis, eval = FALSE}

### `epicontacts` visualisation

ll <- trust_info %>%
  dplyr::ungroup() %>%
  dplyr::mutate(id = 1:n())
c <- w %>% 
  dplyr::left_join(ll %>% select(id1 = id, trust_code), by = c("trust_code1" = "trust_code")) %>%
  dplyr::left_join(ll %>% select(id2 = id, trust_code), by = c("trust_code2" = "trust_code")) %>%
  dplyr::filter(n > 0,
                id1 < id2)
x <- epicontacts::make_epicontacts(linelist = ll,
                                   contacts = c,
                                   id = "trust_code",
                                   from = "trust_code1",
                                   to = "trust_code2",
                                   directed = FALSE)

epicontacts::vis_epicontacts(x, node_color = "nhs_region")

```