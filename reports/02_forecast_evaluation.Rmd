---
title: "Results - forecast evaluation"
author: "Sophie Meakin"
date: "11/03/2021"
output: html_document
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE,
                      fig.width = 16, fig.height = 9)

library(covid19.nhs.data)
library(scoringutils)
library(tidyverse)
library(ggbump)
library(patchwork)

source(here::here("R", "utils.R"))
source(here::here("R", "load_data_fns.R"))

```

```{r load data}

# Load observed data
observed <- load_hospital_data(keep_data = "all_adm")

# Load scores
score_dir <- here::here("data", "out", "evaluation")

adm_scores <- readRDS(file = here::here(score_dir, "full_scoring.rds")) %>%
  dplyr::filter(horizon %in% c(7, 14)) %>%
  dplyr::mutate(date = forecast_from + horizon) %>%
  dplyr::left_join(observed %>%
                     dplyr::select(-nhs_region) %>%
                     dplyr::rename(observed = all_adm),
                   by = c("id", "date")) %>%
  dplyr::mutate(mre = abs(aem)/observed,
                wis_norm = interval_score/(observed + 1))

wis_overall <- readRDS(file = here::here(score_dir, "wis_overall.rds"))
wis_horizon <- readRDS(file = here::here(score_dir, "wis_horizon.rds"))
wis_time <- readRDS(file = here::here(score_dir, "wis_time.rds"))
wis_trust <- readRDS(file = here::here(score_dir, "wis_time.rds"))

# Load admissions forecasts
summary_dir <- here::here("data", "out", "admissions_forecast", "summary")
summary_files <- list.files(summary_dir)[grepl("admissions", list.files(summary_dir))]

forecast_summary <- purrr::map_df(.x = summary_files, .f = ~{
  
  out <- readRDS(file = here::here(summary_dir, .x))
  
}) %>%
  dplyr::bind_rows() %>%
  dplyr::rename(prediction = value) %>%
  dplyr::mutate(range = round(abs(1 - 2 * quantile) * 100),
                boundary = stringr::str_sub(quantile_label, 1, 5)) %>%
  dplyr::select(forecast_from, model, id, horizon, date = date_horizon, range, boundary, prediction)

```

```{r define new variables}

# Date breaks based on forecast dates
plot_dates <- unique(adm_scores$forecast_from)

# Top-50 Trusts by total admissions
top_admissions_50 <- observed %>%
  dplyr::filter(date < as.Date("2021-02-01")) %>%
  dplyr::group_by(id) %>%
  dplyr::summarise(total_adm = sum(all_adm, na.rm = TRUE)) %>%
  dplyr::arrange(-total_adm) %>%
  dplyr::slice_head(n = 50)

# Define forecast ensemble model names
ensemble_models <- c("snaive", "mean_ensemble_forecast", "median_ensemble_forecast")

# Define main (forecast) models names and labels
main_models <- c("snaive",
                 "ts_ensemble_aez",
                 "arima_case7_forecast_raw",
                 "convolution_rt",
                 "median_ensemble_forecast")
main_model_labels <- c("Baseline",
                       "Time series\nensemble",
                       "ARIMA\nregression",
                       "Convolution",
                       "Median\nensemble")
tb_main <- tibble::tibble(model = main_models, label = main_model_labels)

# Define observed models names and labels
obs_models <- c("snaive",
                "ts_ensemble_aez",
                "arima_case7_observed_raw",
                "convolution_observed",
                "median_ensemble_observed")
tb_obs <- tibble::tibble(model = obs_models, label = main_model_labels)

```

```{r empirical coverage}

emp_coverage_dat <- forecast_summary %>%
  dplyr::left_join(observed %>% dplyr::select(id, date, true_value = all_adm), by = c("id", "date")) %>%
  dplyr::filter(horizon %in% 1:14,
                !is.na(true_value)) %>%
  dplyr::mutate(range = paste0(boundary, "_", range)) %>%
  dplyr::select(-boundary) %>%
  tidyr::pivot_wider(id_cols = c(forecast_from, id, true_value, model, horizon, date),
                     names_from = range,
                     values_from = prediction) %>%
  dplyr::group_by(model, horizon) %>%
  dplyr::summarise(empirical50 = length(true_value[which(true_value > lower_50 & true_value < upper_50)])/n(),
                   empirical90 = length(true_value[which(true_value > lower_90 & true_value < upper_90)])/n()) %>%
  dplyr::filter(model %in% c(main_models, obs_models, "mean_ensemble_forecast", "mean_ensemble_observed")) %>%
  tidyr::pivot_longer(cols = contains("empirical")) %>%
  dplyr::mutate(truth = ifelse(name == "empirical50", 0.5, 0.9),
                name = ifelse(name == "empirical50", "50% prediction interval", "90% prediction interval"))

```

# Outputs

* Figure 2 (Overall forecasting accuracy of main forecasting models)
* Figure 3 (Forecasting accuracy by forecast date - 7-day horizon)
* Figure 4 (Forecasting accuracy by location (Trust) - 7-day horizon)
* Figure S6 (Relative contributions of overprediction, sharpness and underprediction to the WIS)
* Figure S7 (Forecasting accuracy by forecast date - 14-day horizon)
* Figure S8 (Forecasting accuracy by location (Trust) - 14-day horizon)
* Figure S9 (Value of using observed, vs. forecast, future confirmed Covid-19 cases for forecasting Trust-level hospital admissions)
* Figure S10 (Value of using observed, vs. forecast, future confirmed Covid-19 cases on forecasting accuracy by Trust and forecast date)
* Table S1 (Relative WIS of all ARIMA regression models with confirmed Covid-19 cases lagged by d days)
* Table S2 (Relative WIS of all ensemble models)


## Overall forecasting accuracy

```{r}

# Overall
pw_overall <- scoringutils::pairwise_comparison(scores = adm_scores %>%
                                                  dplyr::filter(model %in% main_models),
                                                baseline = "snaive",
                                                by = c("horizon", "model", "forecast_from", "id"),
                                                summarise_by = c("model"))
rank_overall <- pw_overall %>%
  dplyr::select(model, scaled_rel_skill) %>%
  unique() %>%
  dplyr::mutate(rank = rank(scaled_rel_skill, ties.method = "min")) %>%
  dplyr::arrange(rank) %>%
  dplyr::select(model, scaled_rel_skill, rank)


# By horizon
pw_horizon <- scoringutils::pairwise_comparison(adm_scores %>%
                                                  dplyr::filter(model %in% main_models),
                                                baseline = "snaive",
                                                by = c("horizon", "model", "forecast_from", "id"),
                                                summarise_by = c("horizon", "model"))
rank_horizon <- pw_horizon %>%
  dplyr::select(horizon, model, scaled_rel_skill) %>%
  unique() %>%
  dplyr::group_by(horizon) %>%
  dplyr::mutate(rank = rank(scaled_rel_skill, ties.method = "min")) %>%
  dplyr::arrange(horizon, rank) %>%
  dplyr::select(horizon, model, scaled_rel_skill, rank)


# All individual scenarios
pw_all <- scoringutils::pairwise_comparison(adm_scores %>%
                                                dplyr::filter(model %in% main_models),
                                              baseline = "snaive",
                                              by = c("horizon", "model", "forecast_from", "id"),
                                              summarise_by = c("horizon", "forecast_from", "id", "model"))
rank_all <- pw_all %>%
  dplyr::select(horizon, forecast_from, id, model, scaled_rel_skill) %>%
  unique() %>%
  dplyr::group_by(horizon, forecast_from, id) %>%
  dplyr::mutate(rank = rank(scaled_rel_skill, ties.method = "min")) %>%
  dplyr::arrange(horizon, forecast_from, id, rank)

```

### Figure 2
```{r}

x_breaks <- c(seq(-1, 2, 0.2), 0)
x_breaks <- x_breaks[order(x_breaks)]

g_overall_calibration <- emp_coverage_dat %>%
  dplyr::filter(model %in% main_models,
                model != "snaive") %>%
  dplyr::left_join(tb_main, by = "model") %>%
  dplyr::mutate(label = ordered(label, main_model_labels)) %>%
  ggplot(aes(x = horizon, y = value, col = label)) +
  geom_line(lwd = 0.6) +
  geom_point(size = 2) +
  geom_line(data = emp_coverage_dat %>%
              dplyr::filter(model == "snaive"),
            lwd = 0.6, col = "lightgrey") +
  geom_point(data = emp_coverage_dat %>%
               dplyr::filter(model == "snaive"),
             size = 2, col = "lightgrey") +
  geom_hline(aes(yintercept = truth), lty = 2) +
  facet_wrap(. ~ name, ncol = 1) +
  scale_x_continuous(breaks = seq(2, 14, 2)) +
  scale_y_continuous(limits = c(0, 1), breaks = seq(0, 1, 0.2)) +
  scale_color_brewer(palette = "Set2") +
  labs(x = "Forecast horizon (days)",
       y = "Empirical prediction interval coverage",
       title = "A",
       col = "Model") +
  theme_bw() +
  theme(legend.position = "top")

g_rwis_overall <- rank_overall %>%
  dplyr::filter(model != "snaive") %>%
  dplyr::left_join(tb_main, by = "model") %>%
  dplyr::mutate(label = ordered(label, main_model_labels)) %>%
  ggplot(aes(y = label, x = scaled_rel_skill-1)) +
  geom_col(fill = "grey50") +
  geom_vline(xintercept = 0, lty = 2) +
  scale_x_continuous(limits = c(-0.25, NA), breaks = x_breaks, labels = x_breaks + 1) +
  scale_fill_distiller(palette = "RdBu", na.value = "grey80",
                       limits = c(-0.4, 0.4)) +
  labs(x = "Scaled WIS", y = "",
       title = "A") +
  theme_bw() +
  theme(legend.position = "none")

g_rwis_horizon7 <- rank_horizon %>%
  dplyr::filter(horizon == 7,
                model != "snaive") %>%
  dplyr::left_join(tb_main, by = "model") %>%
  dplyr::group_by(horizon) %>%
  dplyr::mutate(label = ordered(label, rev(main_model_labels))) %>%
  ggplot(aes(y = label, x = scaled_rel_skill - 1)) +
  geom_col(fill = "grey50") +
  geom_vline(xintercept = 0, lty = 2) +
  facet_wrap(. ~ horizon, scales = "free_x") +
  scale_x_continuous(limits = c(-0.25, NA),
                     breaks = seq(-1, 2, 0.1),
                     labels = seq(-1, 2, 0.1) + 1) +
  scale_fill_distiller(palette = "RdBu", na.value = "grey80",
                       limits = c(-0.4, 0.4)) +
  labs(x = "Scaled WIS", y = "",
       title = "B",
       fill = "Scaled WIS") +
  theme_bw() +
  theme(legend.position = "none")

g_rwis_horizon14 <- rank_horizon %>%
  dplyr::filter(horizon == 14,
                model != "snaive") %>%
  dplyr::left_join(tb_main, by = "model") %>%
  dplyr::group_by(horizon) %>%
  dplyr::mutate(label = ordered(label, rev(main_model_labels))) %>%
  ggplot(aes(y = label, x = scaled_rel_skill - 1)) +
  geom_col(fill = "grey50") +
  geom_vline(xintercept = 0, lty = 2) +
  facet_wrap(. ~ horizon, scales = "free_x") +
  scale_x_continuous(limits = c(-0.25, NA),
                     breaks = seq(-1, 2, 0.4),
                     labels = seq(-1, 2, 0.4) + 1) +
  scale_fill_distiller(palette = "RdBu", na.value = "grey80",
                       limits = c(-0.4, 0.4)) +
  labs(x = "Scaled WIS", y = "",
       fill = "Scaled WIS") +
  theme_bw() +
  theme(legend.position = "none")

g_individual_rank <- rank_all %>%
  dplyr::left_join(tb_main, by = "model") %>%
  dplyr::group_by(label, rank) %>%
  dplyr::summarise(n = n()) %>%
  dplyr::mutate(p = n/sum(n),
                rank = as.character(rank),
                label = ordered(label, rev(main_model_labels))) %>%
  ggplot(aes(y = label, x = p, fill = rank)) +
  geom_col() +
  scale_x_continuous(breaks = seq(0, 1, 0.2)) +
  scale_fill_brewer(palette = "Reds", direction = -1) +
  labs(x = "Proportion of scenarios", y  = "",
       title = "C",
       fill = "Rank") +
  theme_bw()

```

```{r figure 2}

(g_overall_calibration / (g_rwis_horizon7 | g_rwis_horizon14) + plot_layout(heights = c(2, 1))) | g_individual_rank

```

### In-text values
```{r}

# empirical coverage 7 and 14 days
emp_coverage_dat %>%
  dplyr::filter(model %in% c(main_models),
                horizon %in% c(7, 14))

# % times outperforming the baseline
rank_all %>%
  dplyr::select(-scaled_rel_skill) %>%
  tidyr::pivot_wider(id_cols = -c(model, rank), names_from = model, values_from = rank) %>%
  dplyr::ungroup() %>%
  dplyr::summarise(n = n(),
                   median_ensemble_forecast = length(id[which(median_ensemble_forecast < snaive)])/n(),
                   convolution = length(id[which(convolution_rt < snaive)])/n(),
                   arima_reg = length(id[which(arima_case7_forecast_raw < snaive)])/n(),
                   ts_ensemble = length(id[which(ts_ensemble_aez < snaive)])/n())

# % times ranking first
rank_all %>%
  dplyr::filter(rank %in% c(1,2,3)) %>%
  dplyr::group_by(model) %>%
  dplyr::summarise(n = n(),
                   p = n()/4664)

# rWIS and MAE, MRE
adm_scores %>%
  dplyr::filter(model %in% main_models,
                observed != 0) %>%
  dplyr::group_by(model) %>%
  dplyr::summarise(mae = round(mean(aem, na.rm = TRUE), 2),
                   mre = round(mean(mre, na.rm = TRUE), 2)) %>%
  dplyr::left_join(rank_overall, by = c("model")) %>%
  dplyr::arrange(rank) %>%
  kableExtra::kbl() %>%
  kableExtra::kable_styling()

# rWIS and MAE by horizon
adm_scores %>%
  dplyr::filter(model %in% main_models,
                observed != 0) %>%
  dplyr::group_by(horizon, model) %>%
  dplyr::summarise(mae = round(mean(aem, na.rm = TRUE), 2),
                   mre = round(mean(mre, na.rm = TRUE), 2)) %>%
  dplyr::left_join(rank_horizon, by = c("model", "horizon")) %>%
  dplyr::arrange(horizon, rank) %>%
  kableExtra::kbl() %>%
  kableExtra::kable_styling()

```

### Figure S6
```{r}

g_wiscontribution_horizon <- wis_horizon %>%
  dplyr::filter(horizon != 1,
                model %in% main_models) %>%
  dplyr::mutate(model = ordered(model, levels = rev(main_models))) %>%
  dplyr::select(horizon, model, interval_score, sharpness, underprediction, overprediction) %>%
  tidyr::pivot_longer(cols = c(sharpness, underprediction, overprediction)) %>%
  dplyr::mutate(horizon = ifelse(horizon == 1, "1 day", paste0(horizon, " days")),
                horizon = ordered(horizon, c("1 day", "7 days", "14 days"))) %>%
  dplyr::mutate(value_norm = value/interval_score) %>%
  ggplot(aes(y = model, x = value_norm, fill = name)) +
  geom_col() +
  facet_wrap(. ~ horizon) +
  scale_fill_brewer(palette = "Set1") +
  labs(x = "WIS contribution", y = "",
       title = "A",
       fill = "WIS component") +
  theme_bw() +
  theme(legend.position = "top")

g_wiscontribution_time <- wis_time %>%
  dplyr::filter(model %in% main_models,
                horizon == 7) %>%
  dplyr::select(forecast_from, model, interval_score, sharpness, underprediction, overprediction) %>%
  tidyr::pivot_longer(cols = c(sharpness, underprediction, overprediction)) %>%
  dplyr::left_join(rank_time %>% dplyr::select(-scaled_rel_skill),
                   by = c("forecast_from", "model")) %>%
  dplyr::mutate(label = ifelse(rank == 1 & name == "overprediction", "*", NA),
                model = ordered(model, levels = main_models)) %>%
  dplyr::filter(horizon == 7) %>%
  ggplot(aes(x = forecast_from, y = value/interval_score, fill = name)) +
  geom_col() +
  facet_grid(model ~ .) +
  scale_x_date(breaks = plot_dates[seq(2, 18, 2)], date_labels = "%d %b %y",
               limits = c(as.Date("2020-09-28"), as.Date("2021-02-07"))) +
  scale_fill_brewer(palette = "Set1") +
  labs(x = "Forecast date", y = "WIS contribution",
       title = "B",
       fill = "WIS component") +
  theme_bw() +
  theme(legend.position = "none")

```

```{r figure s6}

guide_area() / g_wiscontribution_horizon / g_wiscontribution_time +
  plot_layout(heights = c(0.2, 1, 3), guides = "collect")

```


## By forecast date

```{r}

pw_time <- scoringutils::pairwise_comparison(adm_scores %>%
                                                dplyr::filter(model %in% main_models),
                                             baseline = "snaive",
                                             by = c("horizon", "model", "forecast_from", "id"),
                                             summarise_by = c("forecast_from", "horizon", "model"))

rank_time <- pw_time %>%
  dplyr::select(forecast_from, horizon, model, scaled_rel_skill, relative_skill) %>%
  unique() %>%
  dplyr::group_by(forecast_from, horizon) %>%
  dplyr::mutate(rank = rank(scaled_rel_skill, ties.method = "min")) %>%
  dplyr::arrange(forecast_from, horizon, rank) %>%
  dplyr::mutate(model = ordered(model, main_models))

# MAE
mae_time <- adm_scores %>%
  dplyr::filter(model %in% main_models,
                observed > 5) %>%
  dplyr::group_by(forecast_from, horizon, model) %>%
  dplyr::summarise(n = n(),
                   av_aem = round(mean(aem, na.rm = TRUE), 2),
                   mre = round(mean(mre, na.rm = TRUE), 2),
                   wis_norm = mean(wis_norm, na.rm = TRUE)) %>%
  dplyr::left_join(rank_time, by = c("forecast_from", "horizon", "model")) %>%
  dplyr::mutate(model = ordered(model, main_models))

```

### In-text values
```{r}

# frequency outperforming baseline
rank_time %>%
  dplyr::filter(horizon == 7,
                scaled_rel_skill < 1) %>%
  dplyr::group_by(model) %>%
  dplyr::summarise(n = n())

# rWIS values
rank_time %>%
  dplyr::filter(horizon == 7) %>%
  dplyr::group_by(model) %>%
  dplyr::summarise(med_rwis = median(relative_skill),
                   iq1_rwis = quantile(relative_skill, 0.25),
                   iq3_rwis = quantile(relative_skill, 0.75)) %>%
  dplyr::mutate(iqr = iq3_rwis - iq1_rwis)

# first-ranked model by date
rank_time %>%
  dplyr::filter(horizon == 7) %>%
  dplyr::filter(rank == 1)

# % times first-ranked model
rank_time %>%
  dplyr::filter(horizon == 7,
                rank == 1) %>%
  dplyr::group_by(model) %>%
  dplyr::summarise(n = n())

# % times first-ranked, individual models
rank_time %>%
  dplyr::filter(horizon == 7,
                model != "median_ensemble_forecast",
                model != "snaive") %>%
  dplyr::group_by(forecast_from) %>%
  dplyr::filter(rank == min(rank)) %>%
  dplyr::group_by(model) %>%
  dplyr::summarise(n = n())

# MAE 03 January 2021
mae_time %>%
  dplyr::filter(horizon == 7,
                forecast_from == as.Date("2021-01-03"))


```

### Figure 3
```{r}

# Observed average daily admissions
g_time_obs <- observed %>%
  dplyr::mutate(week = lubridate::ceiling_date(x = date, unit = "week", week_start = 7) - 7) %>%
  dplyr::group_by(id, week) %>%
  dplyr::summarise(all_adm = sum(all_adm, na.rm = TRUE)/7) %>%
  dplyr::group_by(week) %>%
  dplyr::mutate(median_adm = median(all_adm, na.rm = TRUE),
                lwr_adm = quantile(all_adm, 0.25, na.rm = TRUE),
                upr_adm = quantile(all_adm, 0.75, na.rm = TRUE)) %>%
  ggplot() +
  # geom_errorbar(aes(x = week, y = median_adm, ymin = lwr_adm, ymax = upr_adm), 
  #               width = 0, lwd = 4, alpha = 0.4, col = "grey50") +
  # geom_point(aes(x = week, y = all_adm, group = id), alpha = 0.1) +
  # geom_line(aes(x = week, y = median_adm), lwd = 0.8) +
  geom_boxplot(aes(x = week, y = all_adm, group = week)) +
  scale_x_date(breaks = plot_dates[seq(2, 18, 2)], date_labels = "%d %b %y",
               limits = c(as.Date("2020-10-01"), as.Date("2021-02-03"))) +
  scale_y_continuous(limits = c(0, 60)) +
  labs(x = "Target week", y = "Admissions",
       title = "C") +
  theme_bw()

# Relative skill ranking ts
g_time_rank <- rank_time %>%
  dplyr::filter(horizon == 7, model != "snaive") %>%
  dplyr::left_join(tb_main, by = "model") %>%
  dplyr::mutate(label = ordered(label, main_model_labels)) %>%
  ggplot(aes(x = forecast_from, y = rank, col = label)) +
  geom_bump(lwd = 0.6) +
  geom_point(size = 3) +
  scale_x_date(breaks = "2 weeks", date_labels = "%d %b") +
  scale_y_reverse(breaks = integer_breaks()) +
  scale_color_brewer(palette = "Set2") +
  labs(x = "Forecast date", y = "Rank (relative WIS)",
       col = "Model") +
  theme_bw() +
  theme(legend.position = "top")
#
g_time_rank <- g_time_rank +
  geom_bump(data = rank_time %>% dplyr::filter(horizon == 7, model == "snaive"),
            lwd = 0.6, col = "grey70") +
  geom_point(data = rank_time %>% dplyr::filter(horizon == 7, model == "snaive"),
             size = 3, col = "grey70")

# Relative skill value ts
g_time_rwis <- rank_time %>%
  dplyr::filter(horizon == 7) %>%
  dplyr::filter(model != "snaive") %>%
  dplyr::left_join(tb_main, by = "model") %>%
  dplyr::mutate(label = ordered(label, main_model_labels)) %>%
  ggplot(aes(x = forecast_from, y = relative_skill, col = label)) +
  geom_bump(lwd = 0.6) +
  geom_point(size = 2) +
  scale_x_date(breaks = plot_dates[seq(2, 18, 2)], date_labels = "%d %b %y",
               limits = c(as.Date("2020-10-01"), as.Date("2021-02-03"))) +
  scale_y_continuous() +
  scale_color_brewer(palette = "Set2") +
  labs(x = "", y = "Relative WIS",
       title = "A",
       col = "Model") +
  theme_bw() +
  theme(legend.position = "top")
g_time_rwis <- g_time_rwis +
  geom_bump(data = rank_time %>% dplyr::filter(horizon == 7, model == "snaive"),
            lwd = 0.6, col = "grey70") +
  geom_point(data = rank_time %>% dplyr::filter(horizon == 7, model == "snaive"),
             size = 2, col = "grey70")
  
# Scaled skill value ts (vs. baseline)
g_time_swis <- rank_time %>%
  dplyr::filter(horizon == 7) %>%
  dplyr::filter(model != "snaive") %>%
  dplyr::left_join(tb_main, by = "model") %>%
  dplyr::mutate(label = ordered(label, main_model_labels)) %>%
  ggplot(aes(x = forecast_from, y = scaled_rel_skill, col = label)) +
  geom_hline(yintercept = 1, lty = 2, lwd = 0.6, col = "grey50") +
  geom_bump(lwd = 0.6) +
  geom_point(size = 2) +
  scale_x_date(breaks = plot_dates[seq(2, 18, 2)], date_labels = "%d %b %y",
               limits = c(as.Date("2020-10-01"), as.Date("2021-02-03"))) +
  scale_y_continuous() +
  scale_color_brewer(palette = "Set2") +
  labs(x = "", y = "Scaled WIS",
       title = "",
       col = "Model") +
  theme_bw() +
  theme(legend.position = "top")

# MAE ts
g_time_mae <- mae_time %>%
  dplyr::filter(model != "snaive",
                horizon == 7) %>%
  ggplot(aes(x = forecast_from, y = av_aem)) +
  geom_point(aes(col = model), alpha = 0, size = 2) +
  scale_x_date(breaks = plot_dates[seq(2, 18, 2)], date_labels = "%d %b %y",
               limits = c(as.Date("2020-10-01"), as.Date("2021-02-03"))) +
  scale_y_continuous(limits = c(0, 11), breaks = seq(0, 20, 4)) +
  scale_color_brewer(palette = "Set2") +
  labs(x = "Forecast date", y = "MAE",
       title = "B",
       col = "Model") +
  theme_bw() +
  theme(legend.position = "none")
#
g_time_mae <- g_time_mae +
  geom_bump(data = mae_time %>% filter(grepl("median_ensemble", model), horizon == 7),
            aes(col = model), lwd = 0.8) +
  geom_point(data = mae_time %>% filter(grepl("median_ensemble", model), horizon == 7),
             aes(col = model), size = 3) +
  geom_point(data = mae_time %>% filter(rank == 1, horizon == 7),
             aes(col = model), size = 3, alpha = 0.5) +
  geom_point(data = mae_time %>% filter(model == "snaive", horizon == 7),
             shape = 4, stroke = 0.8, col = "grey50")

```

```{r figure 3}

guide_area() / g_time_rwis /g_time_mae / g_time_obs / plot_layout(guides = "collect", heights = c(0.2, 1, 1, 1))

```

### Figure S7
```{r}

# Observed average daily admissions
g_time_obs <- observed %>%
  dplyr::mutate(week = lubridate::ceiling_date(x = date, unit = "week", week_start = 7) - 14) %>%
  dplyr::group_by(id, week) %>%
  dplyr::summarise(all_adm = sum(all_adm, na.rm = TRUE)/7) %>%
  dplyr::group_by(week) %>%
  dplyr::mutate(median_adm = median(all_adm, na.rm = TRUE),
                iq1_adm = quantile(all_adm, 0.25, na.rm = TRUE),
                iq3_adm = quantile(all_adm, 0.75, na.rm = TRUE)) %>%
  ggplot() +
  geom_boxplot(aes(x = week, y = all_adm, group = week)) +
  scale_x_date(breaks = plot_dates[seq(2, 18, 4)], date_labels = "%d %b %y",
               limits = c(as.Date("2020-10-01"), as.Date("2021-02-03"))) +
  scale_y_continuous(limits = c(0, 80)) +
  labs(x = "Week", y = "Admissions",
       title = "C") +
  theme_bw()

# Relative skill value ts
g_time14_rwis <- rank_time %>%
  dplyr::filter(horizon == 14) %>%
  dplyr::filter(model != "snaive") %>%
  dplyr::left_join(tb_main, by = "model") %>%
  dplyr::mutate(label = ordered(label, main_model_labels)) %>%
  ggplot(aes(x = forecast_from, y = relative_skill, col = label)) +
  geom_bump(lwd = 0.6) +
  geom_point(size = 2) +
  scale_x_date(breaks = plot_dates[seq(2, 18, 4)], date_labels = "%d %b %y",
               limits = c(as.Date("2020-10-01"), as.Date("2021-02-03"))) +
  scale_y_continuous(trans = "log2") +
  scale_color_brewer(palette = "Set2") +
  labs(x = "", y = "Relative WIS",
       title = "A",
       col = "Model") +
  theme_bw() +
  theme(legend.position = "top")

g_time14_rwis <- g_time14_rwis +
  geom_bump(data = rank_time %>% dplyr::filter(horizon == 14, model == "snaive"),
            lwd = 0.6, col = "grey70") +
  geom_point(data = rank_time %>% dplyr::filter(horizon == 14, model == "snaive"),
             size = 2, col = "grey70")

# MAE ts
g_time_mae <- mae_time %>%
  dplyr::filter(model != "snaive",
                horizon == 14) %>%
  ggplot(aes(x = forecast_from, y = av_aem)) +
  geom_point(aes(col = model), alpha = 0, size = 2) +
  scale_x_date(breaks = plot_dates[seq(2, 18, 4)], date_labels = "%d %b %y",
               limits = c(as.Date("2020-10-01"), as.Date("2021-02-03"))) +
  scale_y_continuous(limits = c(0, 15), breaks = seq(0, 50, 5)) +
  scale_color_brewer(palette = "Set2") +
  labs(x = "Forecast date", y = "MAE",
       title = "C",
       col = "Model") +
  theme_bw() +
  theme(legend.position = "none")
#
g_time_mae <- g_time_mae +
  geom_bump(data = mae_time %>% filter(grepl("median_ensemble", model), horizon == 14),
            aes(col = model), lwd = 0.8) +
  geom_point(data = mae_time %>% filter(grepl("median_ensemble", model), horizon == 14),
             aes(col = model), size = 3) +
  geom_point(data = mae_time %>% filter(rank == 1, horizon == 14, model != "snaive"),
             aes(col = model), size = 3, alpha = 0.5) +
  geom_point(data = mae_time %>% filter(model == "snaive", horizon == 14),
             shape = 4, stroke = 0.8, col = "grey50")

```

```{r figure s7}

guide_area() / g_time14_rwis / g_time_mae / g_time_obs / plot_layout(guides = "collect", heights = c(0.2, 1, 1, 1))

```

```{r}

# rWIS contributions 14 days - NOT CURRENTLY USED
wis_time %>%
  dplyr::filter(model %in% main_models,
                horizon == 14) %>%
  dplyr::select(forecast_from, model, interval_score, sharpness, underprediction, overprediction) %>%
  tidyr::pivot_longer(cols = c(sharpness, underprediction, overprediction)) %>%
  dplyr::left_join(rank_time %>% dplyr::select(-scaled_rel_skill),
                   by = c("forecast_from", "model")) %>%
  dplyr::mutate(label = ifelse(rank == 1 & name == "overprediction", "*", NA),
                model = ordered(model, levels = main_models)) %>%
  ggplot(aes(x = forecast_from, y = value, fill = name)) +
  geom_col() +
  facet_wrap(. ~ model, ncol = 1, scales = "free_y") +
  scale_fill_brewer(palette = "Set1") +
  labs(x = "", fill = "WIS component") +
  theme_bw() +
  theme(legend.position = "top")

```


## By Trust

```{r}

# Pairwise comparison
pw_trust <- scoringutils::pairwise_comparison(adm_scores %>%
                                                dplyr::filter(model %in% main_models),
                                              baseline = "snaive",
                                              by = c("horizon", "model", "forecast_from", "id"),
                                              summarise_by = c("id", "horizon", "model"))
# Ranking
rank_trust <- pw_trust %>%
  dplyr::select(horizon, id, model, scaled_rel_skill, relative_skill) %>%
  unique() %>%
  dplyr::group_by(horizon, id) %>%
  dplyr::mutate(rank = rank(scaled_rel_skill, ties.method = "min")) %>%
  dplyr::arrange(horizon, id, rank) %>%
  dplyr::left_join(top_admissions_50, by = "id") %>%
  dplyr::ungroup()

mae_trust <- adm_scores %>%
  dplyr::filter(model %in% main_models) %>%
  dplyr::group_by(horizon, id, model) %>%
  dplyr::summarise(av_aem = mean(aem, na.rm = TRUE)) %>%
  dplyr::left_join(rank_trust, by = c("horizon", "id", "model")) %>%
  dplyr::mutate(model = ordered(model, main_models)) %>%
  dplyr::group_by(horizon, id) %>%
  dplyr::mutate(rank1_ae = av_aem[which(rank == 1)],
                ensemble_ae = av_aem[which(model == "median_ensemble_forecast")]) %>%
  dplyr::ungroup()

```

### In-text values
```{r}

# % times outperforming baseline (rWIS < 1)
rank_trust %>%
  dplyr::filter(scaled_rel_skill < 1) %>%
  dplyr::group_by(horizon, model) %>%
  dplyr::summarise(n = n())

# % times ranking first/second
rank_trust %>%
  dplyr::filter(rank %in% c(1, 2)) %>%
  dplyr::group_by(horizon, model) %>%
  dplyr::summarise(n = n()) %>%
  dplyr::mutate(p = n/129)

# convolution model
rank_trust %>%
  dplyr::filter(model == "convolution_rt") %>%
  dplyr::group_by(horizon, model, rank) %>%
  dplyr::summarise(n = n()) %>%
  dplyr::mutate(p = n/129)

# median/IQR rWIS
rank_trust %>%
  dplyr::group_by(horizon, model) %>%
  dplyr::summarise(med_rwis = median(relative_skill),
                   iq1_rwis = quantile(relative_skill, 0.25),
                   iq3_rwis = quantile(relative_skill, 0.75)) %>%
  dplyr::mutate(iqr = iq3_rwis - iq1_rwis)

# median/IQR sWIS
rank_trust %>%
  dplyr::group_by(horizon, model) %>%
  dplyr::summarise(med_swis = median(scaled_rel_skill),
                   iq1_swis = quantile(scaled_rel_skill, 0.25),
                   iq3_swis = quantile(scaled_rel_skill, 0.75)) %>%
  dplyr::mutate(iqr = iq3_swis - iq1_swis)

# median-ensemble biggest improvements
rank_trust %>%
  dplyr::ungroup() %>%
  dplyr::filter(horizon == 7,
                model == "median_ensemble_forecast") %>%
  dplyr::arrange(scaled_rel_skill) %>%
  dplyr::slice_head(n = 3) %>%
  dplyr::left_join(covid19.nhs.data::trust_names, by = c("id" = "trust_code"))

# 14-day horizon, rWIS > 5
rank_trust %>%
  dplyr::ungroup() %>%
  dplyr::filter(horizon == 14,
                scaled_rel_skill > 5) %>%
  dplyr::left_join(covid19.nhs.data::trust_names, by = c("id" = "trust_code"))


# MAE

```


### Figure 4
```{r}

# Relative WIS (tile)
g_location_tile <- rank_trust %>%
  dplyr::filter(id %in% top_admissions_50$id,
                horizon == 7,
                model != "snaive") %>%
  dplyr::left_join(mae_trust %>% dplyr::select(id, model, rank1_ae), by = c("id", "model")) %>%
  dplyr::mutate(model = ordered(model, main_models)) %>%
  ggplot(aes(y = reorder(id, rank1_ae), x = model, fill = log2(scaled_rel_skill))) +
  geom_tile() +
  geom_text(aes(label = round(scaled_rel_skill, 2))) +
  scale_fill_distiller(palette = "RdBu", na.value = "grey70",
                       limits = c(-1.06, 1.06), breaks = seq(-0.5, 0.5, 0.5), labels = c(0.5, 1, 2)) +
  labs(x = "Model", y = "Trust",
       fill = "Relative WIS") +
  theme_bw() +
  theme(legend.position = "bottom")

# Distribution of rWIS
rwis_lines <- rank_trust %>%
  dplyr::filter(horizon == 7) %>%
  dplyr::left_join(tb_main, by = "model") %>%
  dplyr::mutate(model = ordered(label, main_model_labels)) %>%
  dplyr::group_by(model) %>%
  dplyr::summarise(q1 = quantile(relative_skill, 0.25),
                   q2 = quantile(relative_skill, 0.5),
                   q3 = quantile(relative_skill, 0.75)) %>%
  dplyr::mutate(iqr = q3 - q1)
rwis_hist <- rank_trust %>%
  dplyr::filter(horizon == 7,) %>%
  dplyr::left_join(tb_main, by = "model") %>%
  dplyr::mutate(model = ordered(label, main_model_labels),
                rank = as.character(rank))

g_location_rwis <- ggplot() +
  geom_rect(data = rwis_lines %>% filter(model != "Baseline"),
            aes(xmin = q1, xmax = q3, ymin = 0, ymax = Inf, fill = model), alpha = 0.2) +
  geom_rect(data = rwis_lines %>% filter(model == "Baseline"),
            aes(xmin = q1, xmax = q3, ymin = 0, ymax = Inf), fill = "grey50", alpha = 0.2) +
  geom_histogram(data = rwis_hist, aes(x = relative_skill), binwidth = 0.03) +
  geom_vline(data = rwis_lines %>% filter(model != "Baseline"),
             aes(col = model, xintercept = q2), lwd = 0.8) +
  geom_vline(data = rwis_lines %>% filter(model == "Baseline"),
             aes(xintercept = q2), col = "grey50", lwd = 0.8) +
  scale_x_continuous(breaks = seq(0.2, 3, 0.4)) +
  scale_y_continuous(breaks = integer_breaks(), limits = c(NA, 32)) +
  scale_color_brewer(palette = "Set2") +
  scale_fill_brewer(palette = "Set2") +
  facet_grid(rows = vars(model)) +
  labs(x = "Relative WIS", y = "Number of Trusts",
       title = "A") +
  theme_bw() +
  theme(legend.position = "none")

g_location_scatter <- rank_trust %>%
  dplyr::filter(horizon == 7,
                model != "snaive") %>%
  dplyr::select(id, model, rwis = relative_skill) %>%
  dplyr::left_join(rank_trust %>%
                     dplyr::filter(horizon == 7,
                                   model == "snaive") %>%
                     dplyr::select(id, baseline = relative_skill),
                   by = "id") %>%
  dplyr::left_join(tb_main) %>%
  dplyr::mutate(model = ordered(label, main_model_labels)) %>%
  ggplot() +
  geom_abline(slope = 1, intercept = 0, lty = 2, lwd = 0.8, col = "grey50") +
  geom_point(aes(x = baseline, y = rwis, col = model), size = 2, alpha = 0.2) +
  geom_rug(aes(x = baseline, y = rwis), alpha = 0.2) +
  facet_wrap(. ~ model) +
  # scale_x_continuous(trans = "log2", limits = c(NA, 8), breaks = c(0.5, 1, 2, 4, 8)) +
  scale_color_brewer(palette = "Set2") +
  scale_fill_brewer(palette = "Set2") +
  labs(y = "Model rWIS", x = "Baseline rWIS",
       title = "A") +
  theme_bw() +
  theme(legend.position = "none")


# Distribution of sWIS (vs. baseline)
swis_lines <- rank_trust %>%
  dplyr::filter(model != "snaive",
                horizon == 7) %>%
  dplyr::mutate(model = ordered(model, main_models)) %>%
  dplyr::group_by(model) %>%
  dplyr::summarise(q1 = quantile(scaled_rel_skill, 0.25),
                   q2 = quantile(scaled_rel_skill, 0.5),
                   q3 = quantile(scaled_rel_skill, 0.75)) %>%
  dplyr::mutate(iqr = q3 - q1)
swis_hist <- rank_trust %>%
  dplyr::filter(model != "snaive",
                horizon == 7,) %>%
  dplyr::mutate(model = ordered(model, main_models),
                rank = as.character(rank))

g_location_swis <- ggplot() +
  geom_vline(xintercept = 1, lty = 2, lwd = 0.8, col = "lightgrey") +
  geom_rect(data = swis_lines, aes(xmin = q1, xmax = q3, ymin = 0, ymax = Inf, fill = model), alpha = 0.2) +
  geom_histogram(data = swis_hist, aes(x = scaled_rel_skill), binwidth = 0.03) +
  geom_vline(data = swis_lines, aes(col = model, xintercept = q2), lwd = 0.8) +
  scale_x_continuous(trans = "log2") +
  scale_y_continuous(breaks = integer_breaks()) +
  scale_color_brewer(palette = "Set2") +
  scale_fill_brewer(palette = "Set2") +
  facet_grid(rows = vars(model)) +
  labs(x = "Relative WIS", y = "Number of Trusts",
       title = "A") +
  theme_bw() +
  theme(legend.position = "none")


# Distribution of ranks
g_location_rank <- rank_trust %>%
  dplyr::filter(horizon == 7) %>%
  dplyr::group_by(model, rank) %>%
  dplyr::summarise(n = n()) %>%
  dplyr::mutate(p = n/sum(n),
                rank = as.character(rank)) %>%
  dplyr::left_join(tb_main, by = "model") %>%
  dplyr::mutate(label = ordered(label, rev(main_model_labels))) %>%
  ggplot(aes(y = label, x = p, fill = rank)) +
  geom_col() +
  scale_x_continuous(breaks = seq(0, 1, 0.2)) +
  scale_fill_brewer(palette = "Greens", direction = -1) +
  labs(x = "Proportion of Trusts", y  = "",
       title = "B",
       fill = "Rank") +
  theme_bw()

# MAE
g_location_mae0 <- mae_trust %>%
  dplyr::filter(id %in% top_admissions_50$id,
                horizon == 7,
                model != "snaive") %>%
  dplyr::left_join(tb_main, by = "model") %>%
  dplyr::mutate(label = ordered(label, main_model_labels)) %>%
  ggplot(aes(y = reorder(id, ensemble_ae), x = av_aem)) +
  geom_point(aes(col = label), shape = 1, stroke = 1, size = 2, alpha = 0) +
  scale_x_continuous(limits = c(0, NA), breaks = seq(0, 30, 4)) +
  scale_color_brewer(palette = "Set2") +
  labs(x = "Mean absolute error", y = "",
       title = "C",
       col = "Model") +
  theme_bw() +
  theme(legend.position = "top")

g_location_mae0 <- g_location_mae0 +
  geom_point(data = mae_trust %>%
               filter(horizon == 7, rank == 1, id %in% top_admissions_50$id) %>%
               dplyr::left_join(tb_main, by = "model") %>%
               dplyr::mutate(label = ordered(label, main_model_labels)),
             aes(col = label), size = 3, alpha = 0.4) +
  geom_point(data = mae_trust %>%
               filter(horizon == 7, grepl("median_ensemble", model), id %in% top_admissions_50$id) %>%
               dplyr::left_join(tb_main, by = "model") %>%
               dplyr::mutate(label = ordered(label, main_model_labels)),
             aes(col = label), size = 3) +
  geom_point(data = mae_trust %>%
               filter(horizon == 7, model == "snaive", id %in% top_admissions_50$id),
             col = "grey50", shape = 4, stroke = 1, size = 2)

```

```{r figure 4}

guide_area() / (g_location_scatter + g_location_mae0) / (g_location_rank + plot_layout(guides = "keep")) +
  plot_layout(heights = c(0.2, 3, 1), guides = "collect")

```

### Figure S8
```{r}

# Relative WIS (tile)
g_location_tile <- rank_trust %>%
  dplyr::filter(id %in% top_admissions_50$id,
                horizon == 14,
                model != "snaive") %>%
  dplyr::left_join(mae_trust %>% dplyr::select(id, model, rank1_ae), by = c("id", "model")) %>%
  dplyr::mutate(model = ordered(model, main_models)) %>%
  ggplot(aes(y = reorder(id, rank1_ae), x = model, fill = log2(scaled_rel_skill))) +
  geom_tile() +
  geom_text(aes(label = round(scaled_rel_skill, 2))) +
  scale_fill_distiller(palette = "RdBu", na.value = "grey70",
                       limits = c(-1.06, 1.06), breaks = seq(-0.5, 0.5, 0.5), labels = c(0.5, 1, 2)) +
  labs(x = "Model", y = "Trust",
       fill = "Relative WIS") +
  theme_bw() +
  theme(legend.position = "bottom")

# Distribution of rWIS
rwis_lines <- rank_trust %>%
  dplyr::filter(horizon == 14) %>%
  dplyr::left_join(tb_main, by = "model") %>%
  dplyr::mutate(model = ordered(label, main_model_labels)) %>%
  dplyr::group_by(model) %>%
  dplyr::summarise(q1 = quantile(relative_skill, 0.25),
                   q2 = quantile(relative_skill, 0.5),
                   q3 = quantile(relative_skill, 0.75)) %>%
  dplyr::mutate(iqr = q3 - q1)
rwis_hist <- rank_trust %>%
  dplyr::filter(horizon == 14,) %>%
  dplyr::left_join(tb_main, by = "model") %>%
  dplyr::mutate(model = ordered(label, main_model_labels),
                rank = as.character(rank))

g_location_rwis <- ggplot() +
  geom_rect(data = rwis_lines %>% filter(model != "Baseline"),
            aes(xmin = q1, xmax = q3, ymin = 0, ymax = Inf, fill = model), alpha = 0.2) +
  geom_rect(data = rwis_lines %>% filter(model == "Baseline"),
            aes(xmin = q1, xmax = q3, ymin = 0, ymax = Inf), fill = "grey50", alpha = 0.2) +
  geom_histogram(data = rwis_hist, aes(x = relative_skill), binwidth = 0.05) +
  geom_vline(data = rwis_lines %>% filter(model != "Baseline"),
             aes(col = model, xintercept = q2), lwd = 0.8) +
  geom_vline(data = rwis_lines %>% filter(model == "Baseline"),
             aes(xintercept = q2), col = "grey50", lwd = 0.8) +
  scale_x_continuous(limits = c(NA, 8), breaks = c(0.25, 0.5, 1, 2, 4, 8), trans = "log2") +
  scale_y_continuous(breaks = integer_breaks(), limits = c(NA, 20)) +
  scale_color_brewer(palette = "Set2") +
  scale_fill_brewer(palette = "Set2") +
  facet_grid(rows = vars(model)) +
  labs(x = "Relative WIS", y = "Number of Trusts",
       title = "A") +
  theme_bw() +
  theme(legend.position = "none")

g_location_scatter <- rank_trust %>%
  dplyr::filter(horizon == 14,
                model != "snaive") %>%
  dplyr::select(id, model, rwis = relative_skill) %>%
  dplyr::left_join(rank_trust %>%
                     dplyr::filter(horizon == 14,
                                   model == "snaive") %>%
                     dplyr::select(id, baseline = relative_skill),
                   by = "id") %>%
  dplyr::left_join(tb_main) %>%
  dplyr::mutate(model = ordered(label, main_model_labels)) %>%
  ggplot() +
  geom_abline(slope = 1, intercept = 0, lty = 2, lwd = 0.8, col = "grey50") +
  geom_point(aes(x = baseline, y = rwis, col = model), size = 2, alpha = 0.2) +
  geom_rug(aes(x = baseline, y = rwis), alpha = 0.2) +
  facet_wrap(. ~ model) +
  scale_x_continuous(trans = "log2", limits = c(NA, 2)) +
  scale_y_continuous(trans = "log2", limits = c(NA, 8), breaks = c(0.5, 1, 2, 4, 8)) +
  scale_color_brewer(palette = "Set2") +
  scale_fill_brewer(palette = "Set2") +
  labs(x = "Baseline rWIS", y = "Model rWIS") +
  theme_bw() +
  theme(legend.position = "none")


# Distribution of sWIS (vs. baseline)
swis_lines <- rank_trust %>%
  dplyr::filter(model != "snaive",
                horizon == 14) %>%
  dplyr::mutate(model = ordered(model, main_models)) %>%
  dplyr::group_by(model) %>%
  dplyr::summarise(q1 = quantile(scaled_rel_skill, 0.25),
                   q2 = quantile(scaled_rel_skill, 0.5),
                   q3 = quantile(scaled_rel_skill, 0.75)) %>%
  dplyr::mutate(iqr = q3 - q1)
swis_hist <- rank_trust %>%
  dplyr::filter(model != "snaive",
                horizon == 14,) %>%
  dplyr::mutate(model = ordered(model, main_models),
                rank = as.character(rank))

g_location_swis <- ggplot() +
  geom_vline(xintercept = 1, lty = 2, lwd = 0.8, col = "lightgrey") +
  geom_rect(data = swis_lines, aes(xmin = q1, xmax = q3, ymin = 0, ymax = Inf, fill = model), alpha = 0.2) +
  geom_histogram(data = swis_hist, aes(x = scaled_rel_skill), binwidth = 0.03) +
  geom_vline(data = swis_lines, aes(col = model, xintercept = q2), lwd = 0.8) +
  scale_x_continuous(trans = "log2") +
  scale_y_continuous(breaks = integer_breaks()) +
  scale_color_brewer(palette = "Set2") +
  scale_fill_brewer(palette = "Set2") +
  facet_grid(rows = vars(model)) +
  labs(x = "Relative WIS", y = "Number of Trusts",
       title = "A") +
  theme_bw() +
  theme(legend.position = "none")


# Distribution of ranks
g_location_rank <- rank_trust %>%
  dplyr::filter(horizon == 14) %>%
  dplyr::group_by(model, rank) %>%
  dplyr::summarise(n = n()) %>%
  dplyr::mutate(p = n/sum(n),
                rank = as.character(rank)) %>%
  dplyr::left_join(tb_main, by = "model") %>%
  dplyr::mutate(label = ordered(label, rev(main_model_labels))) %>%
  ggplot(aes(y = label, x = p, fill = rank)) +
  geom_col() +
  scale_x_continuous(breaks = seq(0, 1, 0.2)) +
  scale_fill_brewer(palette = "Greens", direction = -1) +
  labs(x = "Proportion of Trusts", y  = "",
       title = "B",
       fill = "Rank") +
  theme_bw()

# MAE
g_location_mae0 <- mae_trust %>%
  dplyr::filter(id %in% top_admissions_50$id,
                horizon == 14,
                model != "snaive") %>%
  dplyr::left_join(tb_main, by = "model") %>%
  dplyr::mutate(label = ordered(label, main_model_labels)) %>%
  ggplot(aes(y = reorder(id, ensemble_ae), x = av_aem)) +
  geom_point(aes(col = label), shape = 1, stroke = 1, size = 2, alpha = 0) +
  scale_x_continuous(limits = c(0, 25), breaks = seq(0, 300, 5)) +
  scale_color_brewer(palette = "Set2") +
  labs(x = "Mean absolute error", y = "",
       title = "C",
       col = "Model") +
  theme_bw() +
  theme(legend.position = "top")

g_location_mae0 <- g_location_mae0 +
  geom_point(data = mae_trust %>%
               filter(horizon == 14, rank == 1, id %in% top_admissions_50$id, model != "snaive") %>%
               dplyr::left_join(tb_main, by = "model") %>%
               dplyr::mutate(label = ordered(label, main_model_labels)),
             aes(col = label), size = 3, alpha = 0.4) +
  geom_point(data = mae_trust %>%
               filter(horizon == 14, grepl("median_ensemble", model), id %in% top_admissions_50$id) %>%
               dplyr::left_join(tb_main, by = "model") %>%
               dplyr::mutate(label = ordered(label, main_model_labels)),
             aes(col = label), size = 3) +
  geom_point(data = mae_trust %>%
               filter(horizon == 14, model == "snaive", id %in% top_admissions_50$id),
             col = "grey50", shape = 4, stroke = 1, size = 2)


```

```{r figure s8}

guide_area() / (g_location_scatter + g_location_mae0) / (g_location_rank + plot_layout(guides = "keep")) +
  plot_layout(heights = c(0.2, 3, 1), guides = "collect")

```


```{r}

# rWIS tile, top 50 Trusts - NOT CURRENTLY USED
rank_trust %>%
  dplyr::filter(model != "snaive",
                horizon == 7,
                !is.na(total_adm)) %>%
  dplyr::mutate(model = ordered(model, main_models)) %>%
  ggplot(aes(y = reorder(id, total_adm), x = model, fill = log2(scaled_rel_skill))) +
  geom_tile() +
  geom_text(aes(label = round(scaled_rel_skill, 2))) +
  scale_fill_distiller(palette = "RdBu", na.value = "grey70",
                       limits = c(-1.1, 1.1), breaks = seq(-1, 1, 1), labels = 2^seq(-1, 1, 1)) +
  labs(x = "Model", y = "Trust",
       fill = "Relative WIS") +
  theme_bw() +
  theme(legend.position = "right")

# Eval by cluster - NOT CURRENTLY USED
n_clusters <- 6

pw_cluster <- scoringutils::pairwise_comparison(adm_scores %>%
                                                  dplyr::left_join(trust_cluster %>%
                                                                     dplyr::filter(k == n_clusters),
                                                                   by = "id") %>%
                                                  dplyr::filter(model %in% main_models,
                                                                !is.na(cluster)),
                                                  baseline = "snaive",
                                                  by = c("horizon", "model", "forecast_from", "cluster", "id"),
                                                  summarise_by = c("cluster", "horizon", "model"))
rank_cluster <- pw_cluster %>%
  dplyr::select(horizon, cluster, model, scaled_rel_skill) %>%
  unique() %>%
  dplyr::group_by(horizon, cluster) %>%
  dplyr::mutate(rank = rank(scaled_rel_skill, ties.method = "min")) %>%
  dplyr::arrange(horizon, cluster, rank) %>%
  dplyr::ungroup()

```


## By cluster

```{r}

# Add cluster information
trust_cluster <- readRDS(file = here::here("data",
                                           "out",
                                           "trust_characteristics",
                                           "trust_cluster_weekly.rds"))
n_clusters <- 5

adm_scores_cluster <- adm_scores %>%
  dplyr::left_join(trust_cluster %>%
                     dplyr::filter(k == n_clusters),
                   by = "id") %>%
  dplyr::filter(!is.na(cluster))

# BY CLUSTER
pw_cluster <- scoringutils::pairwise_comparison(adm_scores_cluster %>%
                                                  dplyr::filter(model %in% main_models),
                                                  baseline = "snaive",
                                                  by = c("horizon", "model", "forecast_from", "cluster", "id"),
                                                  summarise_by = c("cluster", "horizon", "model"))
rank_cluster <- pw_cluster %>%
  dplyr::select(horizon, cluster, model, scaled_rel_skill, relative_skill) %>%
  unique() %>%
  dplyr::group_by(horizon, cluster) %>%
  dplyr::mutate(rank = rank(scaled_rel_skill, ties.method = "min")) %>%
  dplyr::arrange(horizon, cluster, rank) %>%
  dplyr::ungroup()

# BY CLUSTER AND FORECAST DATE
pw_cluster_time <- scoringutils::pairwise_comparison(adm_scores_cluster %>%
                                                  dplyr::filter(model %in% main_models),
                                                  baseline = "snaive",
                                                  by = c("horizon", "model", "forecast_from", "cluster", "id"),
                                                  summarise_by = c("cluster", "forecast_from", "horizon", "model"))
rank_cluster_time <- pw_cluster_time %>%
  dplyr::select(horizon, cluster, forecast_from, model, scaled_rel_skill, relative_skill) %>%
  unique() %>%
  dplyr::group_by(horizon, cluster, forecast_from) %>%
  dplyr::mutate(rank = rank(scaled_rel_skill, ties.method = "min")) %>%
  dplyr::arrange(horizon, cluster, forecast_from, rank) %>%
  dplyr::ungroup()

```

### In-text values

```{r}

rank_cluster_time %>%
  dplyr::filter(horizon == 7,
                cluster == 5,
                model == "convolution_rt")

rank_cluster_time %>%
  dplyr::filter(horizon == 7,
                model == "snaive",
                rank == 5) %>%
  dplyr::group_by(horizon, cluster) %>%
  dplyr::summarise(n = n())

```

```{r}

# Relative WIS values by cluster/model
g_cluster_rwis <- rank_cluster_time %>%
  dplyr::filter(horizon == 7,
                !model %in% c("snaive")) %>%
  dplyr::mutate(model = ordered(model, main_models)) %>%
  ggplot(aes(x = forecast_from, y = relative_skill, col = model)) +
  geom_point() +
  geom_bump() +
  scale_x_date(breaks = plot_dates[seq(2, 18, 4)], date_labels = "%d %b %y",
               limits = c(as.Date("2020-10-01"), as.Date("2021-02-03"))) +
  scale_y_continuous(limits = c(NA, 2.2)) +
  scale_color_brewer(palette = "Set2") +
  facet_wrap(. ~ paste0("Cluster ", cluster), ncol = 1) +
  labs(x = "Forecast date", y = "Relative WIS",
       title = "B",
       col = "Model") +
  theme_bw() +
  theme(legend.position = "top")

g_cluster_rwis <- g_cluster_rwis +
  geom_point(data = rank_cluster_time %>%
               dplyr::filter(horizon == 7,
                             model == "snaive"), col = "lightgrey") +
  geom_bump(data = rank_cluster_time %>%
               dplyr::filter(horizon == 7,
                             model == "snaive"), col = "lightgrey")

# Relative WIS values by cluster/model
g_cluster_swis <- rank_cluster_time %>%
  dplyr::filter(horizon == 7,
                !model %in% c("snaive")) %>%
  dplyr::mutate(model = ordered(model, main_models)) %>%
  ggplot(aes(x = forecast_from, y = scaled_rel_skill, col = model)) +
  geom_point() +
  geom_bump() +
  geom_hline(yintercept = 1, lty = 2, col = "grey50") +
  scale_x_date(breaks = plot_dates[seq(2, 18, 4)], date_labels = "%d %b %y",
               limits = c(as.Date("2020-10-01"), as.Date("2021-02-03"))) +
  scale_y_continuous(trans = "log2", limits = c(NA, 4)) +
  scale_color_brewer(palette = "Set2") +
  facet_wrap(. ~ paste0("Cluster ", cluster), ncol = 1) +
  labs(x = "Forecast date", y = "Scaled WIS",
       title = "C",
       col = "Model") +
  theme_bw() +
  theme(legend.position = "top")

g_cluster_rank <- rank_all %>%
  dplyr::left_join(trust_cluster %>%
                     dplyr::filter(k == n_clusters),
                   by = "id") %>%
  dplyr::filter(!is.na(cluster),
                k == 5) %>%
  dplyr::group_by(horizon, cluster, model, rank) %>%
  dplyr::summarise(n = n()) %>%
  dplyr::mutate(p = n/sum(n),
                rank = as.character(rank),
                model = ordered(model, rev(main_models))) %>%
  dplyr::filter(horizon == 7) %>%
  ggplot(aes(y = model, x = p, fill = rank)) +
  geom_col() +
  facet_wrap(. ~ paste0("Cluster ", cluster), ncol = 1) +
  scale_fill_brewer(palette = "Blues", direction = -1) +
  labs(x = "Proportion of Trusts", y  = "",
       title = "A",
       fill = "Rank") +
  theme_bw()

guide_area() / ((g_cluster_rank + plot_layout(guides = "keep")) |
                  g_cluster_rwis | g_cluster_swis) +
  plot_layout(heights = c(0.1, 1), widths = c(2, 1, 1), guides = "collect")
  
```


## Value of perfect information

```{r}

# By horizon
pw_obs_horizon <- scoringutils::pairwise_comparison(adm_scores %>%
                                                      dplyr::filter(model %in% c(obs_models, "mean_ensemble_observed")),
                                                baseline = "snaive",
                                                by = c("horizon", "model", "forecast_from", "id"),
                                                summarise_by = c("horizon", "model"))
rank_obs_horizon <- pw_obs_horizon %>%
  dplyr::select(horizon, model, scaled_rel_skill) %>%
  unique() %>%
  dplyr::group_by(horizon) %>%
  dplyr::mutate(rank = rank(scaled_rel_skill, ties.method = "min")) %>%
  dplyr::arrange(horizon, rank) %>%
  dplyr::select(horizon, model, scaled_rel_skill, rank)


# By forecast date
pw_obs_time <- scoringutils::pairwise_comparison(adm_scores %>%
                                                  dplyr::filter(model %in% obs_models),
                                                baseline = "snaive",
                                                by = c("horizon", "model", "forecast_from", "id"),
                                                summarise_by = c("horizon", "forecast_from", "model"))
rank_obs_time <- pw_obs_time %>%
  dplyr::select(horizon, forecast_from, model, scaled_rel_skill) %>%
  unique() %>%
  dplyr::group_by(horizon, forecast_from) %>%
  dplyr::mutate(rank = rank(scaled_rel_skill, ties.method = "min")) %>%
  dplyr::arrange(horizon, forecast_from, rank) %>%
  dplyr::select(horizon, forecast_from, model, scaled_rel_skill, rank)


# By Trust
pw_obs_trust <- scoringutils::pairwise_comparison(adm_scores %>%
                                                    dplyr::filter(model %in% obs_models),
                                                  baseline = "snaive",
                                                  by = c("horizon", "model", "forecast_from", "id"),
                                                  summarise_by = c("horizon", "id", "model"))

rank_obs_trust <- pw_obs_trust %>%
  dplyr::select(horizon, id, model, scaled_rel_skill) %>%
  unique() %>%
  dplyr::group_by(horizon, id) %>%
  dplyr::mutate(rank = rank(scaled_rel_skill, ties.method = "min")) %>%
  dplyr::arrange(horizon, id, rank) %>%
  dplyr::select(horizon, id, model, scaled_rel_skill, rank)


# All scenarios
pw_obs_all <- scoringutils::pairwise_comparison(adm_scores %>%
                                                  dplyr::filter(model %in% obs_models),
                                                baseline = "snaive",
                                                by = c("horizon", "model", "forecast_from", "id"),
                                                summarise_by = c("horizon", "forecast_from", "id", "model"))

rank_obs_all <- pw_obs_all %>%
  dplyr::select(horizon, forecast_from, id, model, scaled_rel_skill) %>%
  unique() %>%
  dplyr::group_by(horizon, forecast_from, id) %>%
  dplyr::mutate(rank = rank(scaled_rel_skill, ties.method = "min")) %>%
  dplyr::arrange(horizon, forecast_from, id, rank) %>%
  dplyr::select(horizon, forecast_from, id, model, scaled_rel_skill, rank)

```

```{r}

# ARIMA REGRESSION MODEL
arima_models <- c("snaive", "arima_case7_observed_raw", "arima_case7_forecast_raw")

## By horizon
pw_arima_horizon <- scoringutils::pairwise_comparison(adm_scores %>%
                                                  dplyr::filter(model %in% arima_models),
                                                baseline = "snaive",
                                                by = c("horizon", "model", "forecast_from", "id"),
                                                summarise_by = c("horizon", "model"))

rank_arima_horizon <- pw_arima_horizon %>%
  dplyr::select(horizon, model, scaled_rel_skill) %>%
  unique() %>%
  dplyr::group_by(horizon) %>%
  dplyr::mutate(rank = rank(scaled_rel_skill, ties.method = "min")) %>%
  dplyr::arrange(horizon, rank) %>%
  dplyr::select(horizon, model, scaled_rel_skill, rank)

## By forecast date
pw_arima_time <- scoringutils::pairwise_comparison(adm_scores %>%
                                                  dplyr::filter(model %in% arima_models),
                                                baseline = "snaive",
                                                by = c("horizon", "model", "forecast_from", "id"),
                                                summarise_by = c("horizon", "forecast_from", "model"))

rank_arima_time <- pw_arima_time %>%
  dplyr::select(horizon, forecast_from, model, scaled_rel_skill) %>%
  unique() %>%
  dplyr::group_by(horizon, forecast_from) %>%
  dplyr::mutate(rank = rank(scaled_rel_skill, ties.method = "min")) %>%
  dplyr::arrange(horizon, forecast_from, rank) %>%
  dplyr::select(horizon, forecast_from, model, scaled_rel_skill, rank)

## By Trust
pw_arima_trust <- scoringutils::pairwise_comparison(adm_scores %>%
                                                  dplyr::filter(model %in% arima_models),
                                                baseline = "snaive",
                                                by = c("horizon", "model", "forecast_from", "id"),
                                                summarise_by = c("horizon", "id", "model"))

rank_arima_trust <- pw_arima_trust %>%
  dplyr::select(horizon, id, model, scaled_rel_skill) %>%
  unique() %>%
  dplyr::group_by(horizon, id) %>%
  dplyr::mutate(rank = rank(scaled_rel_skill, ties.method = "min")) %>%
  dplyr::arrange(horizon, id, rank) %>%
  dplyr::select(horizon, id, model, scaled_rel_skill, rank)


# CONVOLUTION MODEL
convolution_models <- c("snaive", "convolution_observed", "convolution_rt")

## By horizon
pw_convolution_horizon <- scoringutils::pairwise_comparison(adm_scores %>%
                                                  dplyr::filter(model %in% convolution_models),
                                                baseline = "snaive",
                                                by = c("horizon", "model", "forecast_from", "id"),
                                                summarise_by = c("horizon", "model"))

rank_convolution_horizon <- pw_convolution_horizon %>%
  dplyr::select(horizon, model, scaled_rel_skill) %>%
  unique() %>%
  dplyr::group_by(horizon) %>%
  dplyr::mutate(rank = rank(scaled_rel_skill, ties.method = "min")) %>%
  dplyr::arrange(horizon, rank) %>%
  dplyr::select(horizon, model, scaled_rel_skill, rank)

## By forecast date
pw_convolution_time <- scoringutils::pairwise_comparison(adm_scores %>%
                                                  dplyr::filter(model %in% convolution_models),
                                                baseline = "snaive",
                                                by = c("horizon", "model", "forecast_from", "id"),
                                                summarise_by = c("horizon", "forecast_from", "model"))

rank_convolution_time <- pw_convolution_time %>%
  dplyr::select(horizon, forecast_from, model, scaled_rel_skill) %>%
  unique() %>%
  dplyr::group_by(horizon, forecast_from) %>%
  dplyr::mutate(rank = rank(scaled_rel_skill, ties.method = "min")) %>%
  dplyr::arrange(horizon, forecast_from, rank) %>%
  dplyr::select(horizon, forecast_from, model, scaled_rel_skill, rank)

## By Trust
pw_convolution_trust <- scoringutils::pairwise_comparison(adm_scores %>%
                                                  dplyr::filter(model %in% convolution_models),
                                                baseline = "snaive",
                                                by = c("horizon", "model", "forecast_from", "id"),
                                                summarise_by = c("horizon", "id", "model"))

rank_convolution_trust <- pw_convolution_trust %>%
  dplyr::select(horizon, id, model, scaled_rel_skill) %>%
  unique() %>%
  dplyr::group_by(horizon, id) %>%
  dplyr::mutate(rank = rank(scaled_rel_skill, ties.method = "min")) %>%
  dplyr::arrange(horizon, id, rank) %>%
  dplyr::select(horizon, id, model, scaled_rel_skill, rank)

```

### In-text values
```{r value of data text values}

# outperforming baseline, all scenarios
rank_obs_all %>%
  dplyr::filter(scaled_rel_skill < 1) %>%
  dplyr::group_by(model) %>%
  dplyr::summarise(n = n(),
                   p = n()/4644)

# outperforming baseline by date
rank_obs_time %>%
  dplyr::filter(scaled_rel_skill < 1) %>%
  dplyr::group_by(horizon, model) %>%
  dplyr::summarise(n = n())

# outperforming baseline by Trust
rank_obs_trust %>%
  dplyr::filter(scaled_rel_skill < 1) %>%
  dplyr::group_by(horizon, model) %>%
  dplyr::summarise(n = n())

rank_obs_trust %>%
  dplyr::group_by(horizon, model) %>%
  dplyr::summarise(med_swis = median(scaled_rel_skill),
                   iq1_swis = quantile(scaled_rel_skill, 0.25),
                   iq3_swis = quantile(scaled_rel_skill, 0.75)) %>%
  dplyr::mutate(iqr = iq3_swis - iq1_swis)

```

### Figure S9
```{r}

# Calibration
g_value_calibration <- emp_coverage_dat %>%
  dplyr::filter(model %in% obs_models,
                model != "snaive") %>% 
  dplyr::mutate(model = ordered(model, c(obs_models, "mean_ensemble_observed"))) %>%
  ggplot(aes(x = horizon, y = value, col = model)) +
  geom_line(lwd = 0.6) +
  geom_point(size = 2) +
  geom_line(data = emp_coverage_dat %>%
              dplyr::filter(model == "snaive"),
            lwd = 0.6, col = "lightgrey") +
  geom_point(data = emp_coverage_dat %>%
               dplyr::filter(model == "snaive"),
             size = 2, col = "lightgrey") +
  geom_hline(aes(yintercept = truth), lty = 2) +
  facet_wrap(. ~ name, ncol = 1) +
  scale_x_continuous(breaks = seq(2, 14, 2)) +
  scale_y_continuous(limits = c(NA, 1), breaks = seq(0, 1, 0.2)) +
  scale_color_brewer(palette = "Set2") +
  labs(x = "Forecast horizon (days)",
       y = "Empirical prediction interval coverage",
       title = "A",
       col = "Model") +
  theme_bw() +
  theme(legend.position = "top")

# rWIS by horizon
g_value_horizon <- rank_obs_horizon %>%
  dplyr::filter(model != "snaive") %>%
  dplyr::mutate(model = ordered(model, rev(obs_models))) %>%
  ggplot(aes(y = model, x = scaled_rel_skill - 1)) +
  geom_col() +
  geom_vline(xintercept = 0, lty = 2) +
  facet_wrap(. ~ horizon) +
  scale_x_continuous(limits = c(-0.25, NA), breaks = seq(-1, 1, 0.1), labels = seq(-1, 1, 0.1) + 1) +
  labs(x = "Relative WIS", y = "",
       title = "B") +
  theme_bw()

# Distribution of all-scenario ranks
g_value_rwisrank <- rank_obs_all %>%
  dplyr::group_by(model, rank) %>%
  dplyr::summarise(n = n()) %>%
  dplyr::mutate(p = n/sum(n),
                rank = as.character(rank),
                model = ordered(model, rev(obs_models))) %>%
  ggplot(aes(y = model, x = p, fill = rank)) +
  geom_col() +
  scale_x_continuous(breaks = seq(0, 1, 0.2)) +
  scale_fill_brewer(palette = "Reds", direction = -1) +
  labs(x = "Proportion of all scenarios", y  = "",
       title = "C",
       fill = "Rank") +
  theme_bw()


# rWIS by forecast date
g_value_time7 <- rank_obs_time %>%
  dplyr::filter(horizon == 7,
                model != "snaive") %>%
  dplyr::mutate(model = ordered(model, obs_models)) %>%
  ggplot(aes(x = forecast_from, y = scaled_rel_skill, col = model)) +
  geom_hline(yintercept = 1, lty = 2, lwd = 0.6, col = "grey50") +
  geom_bump(lwd = 0.8) +
  geom_point(size = 2) +
  # facet_grid(model ~ .) +
  scale_x_date(breaks = plot_dates[seq(2, 18, 4)], date_labels = "%d %b %y",
               limits = c(as.Date("2020-10-01"), as.Date("2021-02-03"))) +
  scale_y_continuous(limits = c(0.35, 1.3), breaks = seq(0, 2, 0.2)) +
  scale_color_brewer(palette = "Set2") +
  labs(x = "Forecast date", y = "Relative WIS",
       title = "D",
       col = "Model") +
  theme_bw() +
  theme(legend.position = "none")

g_value_time14 <- rank_obs_time %>%
  dplyr::filter(horizon == 14,
                model != "snaive") %>%
  dplyr::mutate(model = ordered(model, obs_models)) %>%
  ggplot(aes(x = forecast_from, y = scaled_rel_skill, col = model)) +
  geom_hline(yintercept = 1, lty = 2, lwd = 0.6, col = "grey50") +
  geom_bump(lwd = 0.8) +
  geom_point(size = 2) +
  # facet_grid(model ~ .) +
  scale_x_date(breaks = plot_dates[seq(2, 18, 4)], date_labels = "%d %b %y",
               limits = c(as.Date("2020-10-01"), as.Date("2021-02-03"))) +
  scale_y_continuous(limits = c(0.35, 1.3), breaks = seq(0, 2, 0.2)) +
  scale_color_brewer(palette = "Set2") +
  labs(x = "Forecast date", y = "Relative WIS",
       title = "E",
       col = "Model") +
  theme_bw() +
  theme(legend.position = "none")


# rWIS by Trust
rwis_lines_o <- rank_obs_trust %>%
  dplyr::filter(model != "snaive") %>%
  dplyr::mutate(model = ordered(model, obs_models)) %>%
  dplyr::group_by(horizon, model) %>%
  dplyr::summarise(q1 = quantile(scaled_rel_skill, 0.25),
                   q2 = quantile(scaled_rel_skill, 0.5),
                   q3 = quantile(scaled_rel_skill, 0.75)) %>%
  dplyr::mutate(iqr = q3 - q1)
rwis_hist_o <- rank_obs_trust %>%
  dplyr::filter(model != "snaive") %>%
  dplyr::mutate(model = ordered(model, obs_models),
                rank = as.character(rank))
#
g_value_trust7 <- ggplot() +
  geom_vline(xintercept = 1, lty = 2, lwd = 0.6, col = "grey50") +
  geom_rect(data = rwis_lines_o %>% filter(horizon == 7),
            aes(xmin = q1, xmax = q3, ymin = 0, ymax = Inf, fill = model), alpha = 0.2) +
  geom_histogram(data = rwis_hist_o %>% filter(horizon == 7),
                 aes(x = scaled_rel_skill), binwidth = 0.04) +
  geom_vline(data = rwis_lines_o %>% filter(horizon == 7),
             aes(col = model, xintercept = q2), lwd = 0.8) +
  scale_x_continuous(limits = c(0.4, 2), trans = "log2") +
  scale_color_brewer(palette = "Set2") +
  scale_fill_brewer(palette = "Set2") +
  facet_grid(rows = vars(model)) +
  labs(x = "Relative WIS", y = "Number of Trusts",
       title = "") +
  theme_bw() +
  theme(legend.position = "none")

g_value_trust14 <- ggplot() +
  geom_vline(xintercept = 1, lty = 2, lwd = 0.6, col = "grey50") +
  geom_rect(data = rwis_lines_o %>% filter(horizon == 14),
            aes(xmin = q1, xmax = q3, ymin = 0, ymax = Inf, fill = model), alpha = 0.2) +
  geom_histogram(data = rwis_hist_o %>% filter(horizon == 14),
                 aes(x = scaled_rel_skill), binwidth = 0.04) +
  geom_vline(data = rwis_lines_o %>% filter(horizon == 14),
             aes(col = model, xintercept = q2), lwd = 0.8) +
  scale_x_continuous(limits = c(0.4, 2), trans = "log2") +
  scale_color_brewer(palette = "Set2") +
  scale_fill_brewer(palette = "Set2") +
  facet_grid(rows = vars(model)) +
  labs(x = "Relative WIS", y = "Number of Trusts",
       title = "") +
  theme_bw() +
  theme(legend.position = "none")

```

```{r figure s9}

guide_area() /
  (g_value_calibration | (g_value_horizon | g_value_rwisrank) + plot_layout(guides = "keep")) /
  (g_value_time7 | g_value_trust7) +
  (g_value_time14 | g_value_trust14) +
  plot_layout(heights = c(0.2, 1, 1.5, 1.5), guides = "collect")

```

### Figure S10
```{r}

g_value_arima_trust <- rank_arima_trust %>%
  dplyr::filter(horizon == 14) %>%
  dplyr::select(horizon, id, model, scaled_rel_skill) %>%
  tidyr::pivot_wider(id_cols = c(horizon, id), names_from = model, values_from = scaled_rel_skill) %>%
  dplyr::rename(observed = arima_case7_observed_raw,
                forecast = arima_case7_forecast_raw) %>%
  ggplot(aes(x = forecast, y = observed)) +
  geom_abline(slope = 1, intercept = 0, lty = 2, col = "grey50", lwd = 0.6) +
  geom_point() +
  geom_rug() +
  facet_wrap(. ~ horizon) +
  # scale_x_continuous(limits = c(0, NA)) +
  # scale_y_continuous(limits = c(0, NA)) +
  scale_x_continuous(trans = "log2") +
  scale_y_continuous(trans = "log2") +
  labs(x = "sWIS ARIMA regression, forecast cases",
       y = "sWIS ARIMA regression,\nobserved cases",
       title = "A") +
  theme_bw()

g_value_arima_time <- rank_arima_time %>%
  dplyr::filter(model != "snaive",
                horizon == 14) %>% 
  dplyr::mutate(model = ifelse(model == "arima_case7_observed_raw", "observed", "forecast"),
                model = ordered(model, c("observed", "forecast"))) %>%
  ggplot(aes(x = forecast_from, y = scaled_rel_skill, lty = model)) +
  geom_hline(yintercept = 1, lty = 2, lwd = 0.6, col = "grey50") +
  geom_bump(lwd = 0.8) +
  geom_point(size = 2) +
  facet_wrap(horizon ~ .) +
  scale_x_date(breaks = plot_dates[seq(2, 18, 4)], date_labels = "%d %b %y",
               limits = c(as.Date("2020-10-01"), as.Date("2021-02-03"))) +
  scale_y_continuous(limits = c(0.5, NA), trans = "log2") +
  scale_color_brewer(palette = "Set2") +
  labs(x = "Forecast date", y = "Scaled WIS",
       title = "B",
       col = "Model") +
  theme_bw() +
  theme(legend.position = "none")

g_value_convolution_trust <- rank_convolution_trust %>%
  dplyr::select(horizon, id, model, scaled_rel_skill) %>%
  tidyr::pivot_wider(id_cols = c(horizon, id), names_from = model, values_from = scaled_rel_skill) %>%
  dplyr::filter(convolution_rt < 5) %>%
  ggplot(aes(x = convolution_rt, y = convolution_observed)) +
  geom_abline(slope = 1, intercept = 0, lty = 2, col = "grey50", lwd = 0.6) +
  geom_point() +
  geom_rug() +
  facet_wrap(. ~ horizon, ncol = 1) +
  scale_x_continuous(trans = "log2") +
  scale_y_continuous(trans = "log2") +
  labs(x = "sWIS convolution, forecast cases",
       y = "sWIS convolution,\nobserved cases",
       title = "C") +
  theme_bw()

g_value_convolution_time <- rank_convolution_time %>%
  dplyr::filter(model != "snaive") %>%
  dplyr::mutate(model = ifelse(model == "convolution_observed", "observed", "forecast"),
                model = ordered(model, c("observed", "forecast"))) %>%
  ggplot(aes(x = forecast_from, y = scaled_rel_skill, lty = model)) +
  geom_hline(yintercept = 1, lty = 2, lwd = 0.6, col = "grey50") +
  geom_bump(lwd = 0.8) +
  geom_point(size = 2) +
  facet_wrap(horizon ~ ., ncol = 1, scales = "free_y") +
  scale_x_date(breaks = plot_dates[seq(2, 18, 4)], date_labels = "%d %b %y",
               limits = c(as.Date("2020-10-01"), as.Date("2021-02-03"))) +
  scale_y_continuous(trans = "log2") +
  scale_color_brewer(palette = "Set2") +
  labs(x = "Forecast date", y = "Scaled WIS",
       title = "D",
       lty = "Type") +
  theme_bw()

```

```{r figure s10}

(g_value_arima_trust | g_value_arima_time) /
  (g_value_convolution_trust | g_value_convolution_time) +
  plot_layout(heights = c(1, 2), guides = "collect")

```

## Excluding outliers

```{r}

# OUTLIERS
outliers_999 <- adm_scores %>%
  dplyr::filter(model %in% main_models,
                model != "median_ensemble_forecast",
                interval_score >= quantile(interval_score, 0.999)) %>%
  dplyr::select(forecast_from, id, model, horizon, interval_score) %>%
  dplyr::arrange(horizon, -interval_score)

outliers_999 %>%
  dplyr::group_by(model) %>%
  dplyr::summarise(n = n())

outliers_999 %>%
  dplyr::group_by(forecast_from) %>%
  dplyr::summarise(n = n())

# By horizon
pw_outl_horizon <- scoringutils::pairwise_comparison(adm_scores %>%
                                                      dplyr::filter(model %in% main_models,
                                                                    interval_score < quantile(interval_score, 0.999)),
                                                      baseline = "snaive",
                                                      by = c("horizon", "model", "forecast_from", "id"),
                                                      summarise_by = c("horizon", "model"))
rank_horizon999 <- pw_outl_horizon %>%
  dplyr::select(horizon, model, scaled_rel_skill) %>%
  unique() %>%
  dplyr::group_by(horizon) %>%
  dplyr::mutate(rank = rank(scaled_rel_skill, ties.method = "min")) %>%
  dplyr::arrange(horizon, rank) %>%
  dplyr::select(horizon, model, scaled_rel_skill, rank)

# By forecast date
pw_outl_time <- scoringutils::pairwise_comparison(adm_scores %>%
                                                      dplyr::filter(model %in% main_models,
                                                                    interval_score < quantile(interval_score, 0.999)),
                                                baseline = "snaive",
                                                by = c("horizon", "model", "forecast_from", "id"),
                                                summarise_by = c("horizon", "forecast_from", "model"))
rank_outl_time <- pw_outl_time %>%
  dplyr::select(horizon, forecast_from, model, scaled_rel_skill, relative_skill) %>%
  unique() %>%
  dplyr::group_by(horizon, forecast_from) %>%
  dplyr::mutate(rank = rank(scaled_rel_skill, ties.method = "min")) %>%
  dplyr::arrange(horizon, forecast_from, rank)

```

```{r}

rank_horizon999 %>%
  dplyr::rename(forecast_99.9 = scaled_rel_skill) %>%
  dplyr::left_join(rank_horizon %>%
                     dplyr::rename(forecast = scaled_rel_skill),
                   by = c("horizon", "model")) %>%
  dplyr::left_join(rank_obs_horizon %>%
                     dplyr::rename(observed = scaled_rel_skill) %>%
                     dplyr::mutate(model = case_when(grepl("arima", model) ~ "arima_case7_forecast_raw",
                                                     grepl("conv", model) ~ "convolution_rt",
                                                     TRUE ~ paste0(model))),
                   by = c("horizon", "model")) %>%
  dplyr::select(horizon, model, forecast, forecast_99.9, observed) %>%
  dplyr::filter(!grepl("median_ensemble", model),
                model != "snaive") %>%
  dplyr::mutate(model = ordered(model, main_models)) %>%
  dplyr::arrange(horizon, model)

g_outtime_rwis7 <- rank_outl_time %>%
  dplyr::filter(horizon == 7, model != "snaive") %>%
  dplyr::mutate(model = ordered(model, main_models)) %>%
  ggplot(aes(x = forecast_from, y = relative_skill, col = model)) +
  geom_bump(lwd = 0.6) +
  geom_point(size = 3) +
  scale_x_date(breaks = plot_dates[seq(2, 18, 4)], date_labels = "%d %b %y",
               limits = c(as.Date("2020-10-01"), as.Date("2021-02-03"))) +
  scale_color_brewer(palette = "Set2") +
  labs(x = "Forecast date", y = "Relative WIS",
       col = "Model") +
  theme_bw() +
  theme(legend.position = "top")
#
g_outtime_rwis7 <- g_outtime_rwis7 +
  geom_bump(data = rank_outl_time %>% dplyr::filter(horizon == 7, model == "snaive"),
            lwd = 0.6, col = "grey70") +
  geom_point(data = rank_outl_time %>% dplyr::filter(horizon == 7, model == "snaive"),
             size = 3, col = "grey70")


g_outtime_rwis14 <- rank_outl_time %>%
  dplyr::filter(horizon == 14, model != "snaive") %>%
  dplyr::mutate(model = ordered(model, main_models)) %>%
  ggplot(aes(x = forecast_from, y = relative_skill, col = model)) +
  geom_bump(lwd = 0.6) +
  geom_point(size = 3) +
  scale_x_date(breaks = plot_dates[seq(2, 18, 4)], date_labels = "%d %b %y",
               limits = c(as.Date("2020-10-01"), as.Date("2021-02-03"))) +
  scale_color_brewer(palette = "Set2") +
  labs(x = "Forecast date", y = "Relative WIS",
       col = "Model") +
  theme_bw() +
  theme(legend.position = "top")
#
g_outtime_rwis14 <- g_outtime_rwis14 +
  geom_bump(data = rank_outl_time %>% dplyr::filter(horizon == 14, model == "snaive"),
            lwd = 0.6, col = "grey70") +
  geom_point(data = rank_outl_time %>% dplyr::filter(horizon == 14, model == "snaive"),
             size = 3, col = "grey70")

rank_time %>%
  dplyr::left_join(rank_outl_time, by = c("forecast_from", "horizon", "model")) %>%
  dplyr::filter(model != "snaive") %>%
  dplyr::mutate(model = ordered(model, main_models),
                label = ifelse(scaled_rel_skill.y < 0.9*scaled_rel_skill.x,
                               paste0(forecast_from),
                               NA)) %>%
  ggplot(aes(x = scaled_rel_skill.x, y = scaled_rel_skill.y, col = model)) +
  geom_point(size = 2) +
  geom_text_repel(aes(label = label)) +
  geom_abline(slope = 1, intercept = 0, lty = 2, col = "grey50") +
  facet_wrap(. ~ horizon) +
  scale_x_continuous(trans = "log2") +
  scale_y_continuous(trans = "log2") +
  scale_color_brewer(palette = "Set2") +
  labs(x = "Scaled WIS, all forecasts", y = "Scaled WIS, outliers excluded",
       col = "Model") +
  theme_bw()
  

```


## Supplementary Information

### Table S1
```{r}

# ARIMA regression, observed cases
pw_arima_obs <- scoringutils::pairwise_comparison(scores = adm_scores %>%
                                                  dplyr::filter(model == "snaive" |
                                                                  (grepl("arima_case", model) & grepl("observed", model))),
                                                baseline = "snaive",
                                                by = c("horizon", "model", "forecast_from", "id"),
                                                summarise_by = c("horizon", "model"))
rank_arima_obs <- pw_arima_obs %>%
  dplyr::select(horizon, model, scaled_rel_skill) %>%
  unique() %>%
  dplyr::group_by(horizon) %>%
  dplyr::mutate(rank = rank(scaled_rel_skill, ties.method = "min")) %>%
  dplyr::arrange(horizon, rank) %>%
  dplyr::select(horizon, model, scaled_rel_skill, rank)


# ARIMA regression, forecast cases
pw_arima_fct <- scoringutils::pairwise_comparison(scores = adm_scores %>%
                                                  dplyr::filter(model == "snaive" |
                                                                  (grepl("arima_case", model) & grepl("forecast", model))),
                                                baseline = "snaive",
                                                by = c("horizon", "model", "forecast_from", "id"),
                                                summarise_by = c("horizon", "model"))
rank_arima_fct <- pw_arima_fct %>%
  dplyr::select(horizon, model, scaled_rel_skill) %>%
  unique() %>%
  dplyr::group_by(horizon) %>%
  dplyr::mutate(rank = rank(scaled_rel_skill, ties.method = "min")) %>%
  dplyr::arrange(horizon, rank) %>%
  dplyr::select(horizon, model, scaled_rel_skill, rank)

```

```{r table s1}

rank_arima_obs %>%
  dplyr::select(horizon, model, rwis = scaled_rel_skill) %>%
  dplyr::mutate(data = "observed",
                model = stringr::str_remove(model, "_observed_raw")) %>%
  dplyr::bind_rows(rank_arima_fct %>%
                     dplyr::select(horizon, model, rwis = scaled_rel_skill) %>%
                     dplyr::mutate(data = "forecast",
                                   model = stringr::str_remove(model, "_forecast_raw"))) %>%
  dplyr::mutate(horizon = paste0("h_", horizon)) %>%
  dplyr::filter(model != "snaive") %>%
  tidyr::pivot_wider(id_cols = -c(horizon, rwis), names_from = horizon, values_from = rwis) %>%
  dplyr::select(data, model, h_7, h_14)

```


### Table S2
```{r}

# Observed cases
pw_ensemble_obs <- scoringutils::pairwise_comparison(scores = adm_scores %>%
                                                  dplyr::filter(model %in% c("snaive",
                                                                             "mean_ensemble_observed",
                                                                             "median_ensemble_observed")),
                                                baseline = "snaive",
                                                by = c("horizon", "model", "forecast_from", "id"),
                                                summarise_by = c("horizon", "model"))
rank_ensemble_obs <- pw_ensemble_obs %>%
  dplyr::select(horizon, model, scaled_rel_skill) %>%
  unique() %>%
  dplyr::group_by(horizon) %>%
  dplyr::mutate(rank = rank(scaled_rel_skill, ties.method = "min")) %>%
  dplyr::arrange(horizon, rank) %>%
  dplyr::select(horizon, model, scaled_rel_skill, rank)


# Forecast cases
pw_ensemble_fct <- scoringutils::pairwise_comparison(scores = adm_scores %>%
                                                  dplyr::filter(model %in% c("snaive",
                                                                             "mean_ensemble_forecast",
                                                                             "median_ensemble_forecast")),
                                                baseline = "snaive",
                                                by = c("horizon", "model", "forecast_from", "id"),
                                                summarise_by = c("horizon", "model"))
rank_ensemble_fct <- pw_ensemble_fct %>%
  dplyr::select(horizon, model, scaled_rel_skill) %>%
  unique() %>%
  dplyr::group_by(horizon) %>%
  dplyr::mutate(rank = rank(scaled_rel_skill, ties.method = "min")) %>%
  dplyr::arrange(horizon, rank) %>%
  dplyr::select(horizon, model, scaled_rel_skill, rank)

```

```{r table s2}

rank_ensemble_obs %>%
  dplyr::select(horizon, model, rwis = scaled_rel_skill) %>%
  dplyr::mutate(data = "observed",
                model = stringr::str_remove(model, "_observed")) %>%
  dplyr::bind_rows(rank_ensemble_fct %>%
                     dplyr::select(horizon, model, rwis = scaled_rel_skill) %>%
                     dplyr::mutate(data = "forecast",
                                   model = stringr::str_remove(model, "_forecast"))) %>%
  dplyr::mutate(horizon = paste0("h_", horizon)) %>%
  dplyr::filter(model != "snaive") %>%
  tidyr::pivot_wider(id_cols = -c(horizon, rwis), names_from = horizon, values_from = rwis) %>%
  dplyr::select(data, model, h_7, h_14)

```

