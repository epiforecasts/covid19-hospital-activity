---
title: "Results - forecast evaluation"
author: "Sophie Meakin"
date: "01/07/2021"
output: html_document
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE,
                      fig.width = 16, fig.height = 9)

fig_text_size <- 14

library(tidyverse)
library(covid19.nhs.data)
library(covidregionaldata)
library(scoringutils)
library(ggbump)
library(ggrepel)
library(patchwork)

source(here::here("R", "utils.R"))
source(here::here("R", "load_data_fns.R"))
source(here::here("R", "evaluation_fns.R"))

```

```{r load data}

# Load observed data
observed <- load_hospital_data(keep_data = "all_adm")

# Load scores
score_dir <- here::here("data", "out", "evaluation")

## Empirical coverage
emp_coverage <- readRDS(file = here::here(score_dir, "empirical_coverage.rds"))

## All scores
adm_scores <- readRDS(file = here::here(score_dir, "scores_full.rds")) %>%
  dplyr::filter(horizon %in% c(7, 14)) %>%
  dplyr::mutate(date = forecast_from + horizon) %>%
  dplyr::left_join(observed %>%
                     dplyr::select(-nhs_region) %>%
                     dplyr::rename(observed = all_adm),
                   by = c("id", "date")) %>%
  dplyr::mutate(mre = abs(aem)/observed,
                wis_norm = interval_score/(observed + 1))

```

```{r define new variables}

# Date breaks based on forecast dates
plot_dates <- sort(unique(adm_scores$forecast_from))

# Top-x Trusts by total admissions
top_admissions_x <- observed %>%
  dplyr::filter(date < as.Date("2021-05-01")) %>%
  dplyr::group_by(id) %>%
  dplyr::summarise(total_adm = sum(all_adm, na.rm = TRUE)) %>%
  dplyr::arrange(-total_adm) %>%
  dplyr::slice_head(n = 40)

# Define main (forecast) models names and labels
main_models <- c("baseline",
                 "tsensemble_aez",
                 "arimareg_7_forecast",
                 "convolution_forecast_noprior",
                 "mean_ensemble_forecast")
main_model_labels <- c("Baseline",
                       "Time series\nensemble",
                       "ARIMA\nregression",
                       "Convolution",
                       "Mean\nensemble")
tb_main <- tibble::tibble(model = main_models, label = main_model_labels)

# Define observed models names and labels
obs_models <- c("baseline",
                 "tsensemble_aez",
                 "arimareg_7_observed",
                 "convolution_observed_noprior",
                 "mean_ensemble_observed")
tb_obs <- tibble::tibble(model = obs_models, label = main_model_labels)

# Custom colour/fill
fill_models <- scale_fill_manual(breaks = main_model_labels, 
                                 values = c("lightgrey", "#66C2A5", "#FC8D62", "#8DA0CB", "#E78AC3", "#A6D854"))
color_models <- scale_color_manual(breaks = main_model_labels,
                                   values = c("lightgrey", "#66C2A5", "#FC8D62", "#8DA0CB", "#E78AC3", "#A6D854"))

```

# Main text

* Figure 2 (Overall forecasting accuracy of main forecasting models)
* Figure 3 (Forecasting accuracy by forecast date - 7-day horizon)
* Figure 4 (Forecasting accuracy by location (Trust) - 7-day horizon)
* Figure S6 (Relative contributions of overprediction, sharpness and underprediction to the WIS)
* Figure S7 (Forecasting accuracy by forecast date - 14-day horizon)
* Figure S8 (Forecasting accuracy by location (Trust) - 14-day horizon)
* Figure S9 (Value of using observed, vs. forecast, future confirmed Covid-19 cases for forecasting Trust-level hospital admissions)
* Figure S10 (Value of using observed, vs. forecast, future confirmed Covid-19 cases on forecasting accuracy by Trust and forecast date)
* Table S1 (Relative WIS of all ARIMA regression models with confirmed Covid-19 cases lagged by d days)
* Table S2 (Relative WIS of all ensemble models)


## Overall

```{r}

# Overall
rank_overall <- eval_pipeline(raw_scores = adm_scores,
                              models = main_models,
                              summarise_by = "model")


# By horizon
rank_horizon <- eval_pipeline(raw_scores = adm_scores,
                              models = main_models,
                              summarise_by = c("horizon", "model"))

# All individual scenarios
# rank_all <- eval_pipeline(raw_scores = adm_scores,
#                           models = main_models,
#                           summarise_by = c("horizon", "forecast_from", "id", "model"))
# saveRDS(object = rank_all,
#         file = here::here(score_dir, "pairwise_forecast.rds"))
rank_all <- readRDS(file = here::here(score_dir, "pairwise_forecast.rds"))

```

### In-text values
```{r}

# % times ranking first
rank_all %>%
  dplyr::group_by(model) %>%
  dplyr::summarise(n = n(),
                   p1 = sum(rank == 1)/n(),
                   p12 = sum(rank %in% c(1,2))/n(),
                   p123 = sum(rank %in% c(1,2,3))/n(),
                   p45 = sum(rank %in% c(4,5))/n())

# % times outperforming the baseline
rank_all %>%
  dplyr::select(horizon, forecast_from, id, model, rank) %>%
  tidyr::pivot_wider(id_cols = -c(model, rank), names_from = model, values_from = rank) %>%
  dplyr::ungroup() %>%
  dplyr::summarise(n = n(),
                   mean_ensemble = length(id[which(mean_ensemble_forecast < baseline)])/n(),
                   convolution = length(id[which(convolution_forecast_noprior < baseline)])/n(),
                   arima_reg = length(id[which(arimareg_7_forecast < baseline)])/n(),
                   ts_ensemble = length(id[which(tsensemble_aez < baseline)])/n())

```

### Figure 2
```{r}

x_breaks <- c(seq(-1, 2, 0.2), 0)
x_breaks <- x_breaks[order(x_breaks)]

g_overall_calibration <- emp_coverage %>%
  dplyr::filter(model %in% main_models) %>%
  dplyr::left_join(tb_main, by = "model") %>%
  dplyr::mutate(label = ordered(label, main_model_labels)) %>%
  ggplot(aes(x = horizon, y = value, col = label)) +
  geom_line(lwd = 0.6) +
  geom_point(size = 2) +
  geom_hline(aes(yintercept = truth), lty = 2) +
  facet_grid(name ~ .) +
  scale_x_continuous(breaks = seq(2, 14, 2)) +
  scale_y_continuous(limits = c(0, 1), breaks = seq(0, 1, 0.2)) +
  color_models +
  labs(x = "Forecast horizon (days)",
       y = "Empirical coverage",
       title = "A",
       col = "Model") +
  theme_bw() +
  theme(legend.position = "top") +
  theme(text = element_text(size = 14)) +
  guides(col = guide_legend(nrow=1, byrow=TRUE))

g_rwis_horizon <- rank_horizon %>%
  dplyr::left_join(tb_main, by = "model") %>%
  dplyr::group_by(horizon) %>%
  dplyr::mutate(label = ordered(label, rev(main_model_labels)),
                horizon = as.character(horizon),
                horizon = ordered(horizon, c("7", "14"))) %>%
  ggplot(aes(y = label, x = rwis, col = horizon)) +
  geom_point(size = 4) +
  scale_color_brewer(palette = "Paired") +
  labs(x = "Relative WIS", y = "",
       title = "B",
       col = "Horizon (days)") +
  theme_bw() +
  theme(legend.position = "top") +
  theme(text = element_text(size = fig_text_size))

g_individual_rank <- rank_all %>%
  dplyr::left_join(tb_main, by = "model") %>%
  dplyr::group_by(label, rank) %>%
  dplyr::summarise(n = n()) %>%
  dplyr::mutate(p = n/sum(n),
                rank = as.character(rank),
                label = ordered(label, rev(main_model_labels))) %>%
  ggplot(aes(y = label, x = p, fill = rank)) +
  geom_col() +
  scale_x_continuous(breaks = seq(0, 1, 0.2)) +
  scale_fill_brewer(palette = "Reds", direction = -1) +
  labs(x = "Proportion of scenarios", y  = "",
       title = "C",
       fill = "Rank") +
  theme_bw() +
  theme(legend.position = "top",
        text = element_text(size = fig_text_size)) +
  guides(fill = guide_legend(nrow=1, byrow=TRUE))

#####

g_fig2 <- (g_overall_calibration | g_rwis_horizon) /
  g_individual_rank

ggsave(plot = g_fig2,
       filename = here::here("data", "out", "figures", "figure_2.png"),
       width = 14, height = 8, units = "in",
       dpi = 500)

ggsave(plot = g_fig2,
       filename = here::here("data", "out", "figures", "figure_2.pdf"),
       width = 14, height = 10, units = "in",
       dpi = 500)

```

### Table S3
```{r}

tb_scores <- readRDS(file = here::here(score_dir, "wis_horizon.rds")) %>%
  dplyr::filter(horizon %in% c(7, 14),
                model %in% main_models) %>%
  dplyr::left_join(emp_coverage %>%
                     dplyr::ungroup() %>%
                     dplyr::mutate(name = paste0("pi_", 100*truth)) %>%
                     dplyr::select(-truth) %>%
                     tidyr::pivot_wider(),
                   by = c("horizon", "model")) %>%
  dplyr::left_join(rank_horizon %>%
                     dplyr::select(horizon, model, rwis, swis),
                   by = c("horizon", "model")) %>%
  dplyr::left_join(tb_main, by = "model") %>%
  dplyr::mutate(pi_50 = round(pi_50, 2),
                pi_90 = round(pi_90, 2),
                bias = round(bias, 3),
                sharpness = round(sharpness, 2),
                mae = round(aem, 2),
                rwis = round(rwis, 2),
                swis = round(swis, 2),
                label = ordered(label, main_model_labels)) %>%
  dplyr::arrange(horizon, label)

tb_scores %>%
  dplyr::select(horizon, label, pi_50, pi_90, sharpness, bias, mae, rwis, swis) %>%
  dplyr::mutate(bias = "") %>%
  kableExtra::kbl() %>%
  kableExtra::kable_styling()

```


## By forecast date

```{r}

rank_time <- eval_pipeline(raw_scores = adm_scores,
                           models = main_models,
                           summarise_by = c("forecast_from", "horizon", "model"))

                              
# MAE
mae_time <- adm_scores %>%
  dplyr::filter(model %in% main_models) %>%
  dplyr::group_by(forecast_from, horizon, model) %>%
  dplyr::summarise(n = n(),
                   mae = round(mean(aem, na.rm = TRUE), 2)) %>%
  dplyr::left_join(rank_time, by = c("forecast_from", "horizon", "model")) %>%
  dplyr::mutate(model = ordered(model, main_models)) %>%
  dplyr::left_join(tb_main, by = "model") %>%
  dplyr::mutate(label = ordered(label, main_model_labels))

```

### In-text values
```{r}

# frequency outperforming baseline
rank_time %>%
  dplyr::group_by(horizon, model) %>%
  dplyr::summarise(n_tot = n(),
                   n = sum(swis < 1)) %>%
  dplyr::mutate(p = n/n_tot) %>%
  dplyr::arrange(horizon, model)

# % times first-ranked model
rank_time %>%
  dplyr::group_by(horizon, model, rank) %>%
  dplyr::summarise(n = n()) %>%
  tidyr::pivot_wider(names_from = model, values_from = n) %>%
  dplyr::arrange(horizon, rank)

# % times first-ranked, individual models
rank_time %>%
  dplyr::filter(model != "mean_ensemble_forecast",
                model != "baseline") %>%
  dplyr::group_by(horizon, forecast_from) %>%
  dplyr::filter(rank == min(rank)) %>%
  dplyr::group_by(horizon, model) %>%
  dplyr::summarise(n = n())

# improvement of mean-ensemble over baseline
rank_time %>%
  dplyr::filter(horizon == 7,
                model == "mean_ensemble_forecast")

```

### Figure 3
```{r}

# Relative skill value
g_time_rwis <- rank_time %>%
  dplyr::filter(horizon == 7) %>%
  dplyr::left_join(tb_main, by = "model") %>%
  dplyr::mutate(label = ordered(label, main_model_labels)) %>%
  ggplot(aes(x = forecast_from, y = rwis, col = label)) +
  geom_bump(lwd = 0.8) +
  geom_point(size = 2) +
  scale_x_date(breaks = plot_dates[seq(2, length(plot_dates), 4)], date_labels = "%d %b %y",
               limits = c(as.Date("2020-10-01"), as.Date("2021-05-02"))) +
  scale_y_continuous(breaks = seq(0, 3, 0.4)) +
  color_models +
  labs(x = "", y = "Relative WIS",
       title = "A",
       col = "Model") +
  theme_bw() +
  theme(legend.position = "top") +
  theme(text = element_text(size = fig_text_size)) +
  guides(col = guide_legend(nrow=1, byrow=TRUE))
  
# Mean AE
g_time_mae <- mae_time %>%
  dplyr::filter(horizon == 7) %>%
  ggplot(aes(x = forecast_from, y = mae)) +
  geom_bump(aes(col = label), lwd = 0.8) +
  geom_point(aes(col = label), size = 2) +
  scale_x_date(breaks = plot_dates[seq(2, length(plot_dates), 4)], date_labels = "%d %b %y",
               limits = c(as.Date("2020-10-01"), as.Date("2021-05-02"))) +
  color_models +
  labs(x = "Forecast date", y = "MAE",
       title = "B",
       col = "Model") +
  theme_bw() +
  theme(legend.position = "none") +
  theme(text = element_text(size = fig_text_size)) +
  guides(col = guide_legend(nrow = 1, byrow = TRUE))

# Observed average daily admissions
g_time_obs <- observed %>%
  dplyr::mutate(week = lubridate::ceiling_date(x = date, unit = "week", week_start = 7) - 7) %>%
  dplyr::group_by(id, week) %>%
  dplyr::summarise(all_adm = mean(all_adm, na.rm = TRUE)) %>%
  dplyr::group_by(week) %>%
  dplyr::mutate(median_adm = median(all_adm, na.rm = TRUE),
                lwr_adm = quantile(all_adm, 0.25, na.rm = TRUE),
                upr_adm = quantile(all_adm, 0.75, na.rm = TRUE)) %>%
  dplyr::filter(week < as.Date("2021-05-01")) %>%
  ggplot() +
  geom_boxplot(aes(x = week, y = all_adm, group = week)) +
  scale_x_date(breaks = plot_dates[seq(2, length(plot_dates), 4)], date_labels = "%d %b %y",
               limits = c(as.Date("2020-10-01"), as.Date("2021-05-02"))) +
  scale_y_continuous(limits = c(0, 60)) +
  labs(x = "Target week", y = "Admissions",
       title = "C") +
  theme_bw() +
  theme(text = element_text(size = fig_text_size))

#####

g_figure_3 <- guide_area() /
  g_time_rwis /
  g_time_mae /
  g_time_obs /
  plot_layout(guides = "collect", heights = c(0.2, 1, 1, 1))

ggsave(plot = g_figure_3,
       filename = here::here("data", "out", "figures", "figure_3.png"),
       width = 14, height = 8, units = "in",
       dpi = 500)

ggsave(plot = g_figure_3,
       filename = here::here("data", "out", "figures", "figure_3.pdf"),
       width = 14, height = 10, units = "in",
       dpi = 500)

#####

```


### Figure S5
```{r}

# Observed average daily admissions
g_time_obs <- observed %>%
  dplyr::mutate(week = lubridate::ceiling_date(x = date, unit = "week", week_start = 7) - 14) %>%
  dplyr::group_by(id, week) %>%
  dplyr::summarise(all_adm = mean(all_adm, na.rm = TRUE)) %>%
  dplyr::group_by(week) %>%
  dplyr::mutate(median_adm = median(all_adm, na.rm = TRUE),
                lwr_adm = quantile(all_adm, 0.25, na.rm = TRUE),
                upr_adm = quantile(all_adm, 0.75, na.rm = TRUE)) %>%
  dplyr::filter(week < as.Date("2021-05-01")) %>%
  ggplot() +
  geom_boxplot(aes(x = week, y = all_adm, group = week)) +
  scale_x_date(breaks = plot_dates[seq(2, length(plot_dates), 4)], date_labels = "%d %b %y",
               limits = c(as.Date("2020-10-01"), as.Date("2021-05-02"))) +
  scale_y_continuous(limits = c(0, 60)) +
  labs(x = "Target week", y = "Admissions",
       title = "C") +
  theme_bw() +
  theme(text = element_text(size = fig_text_size))

# Relative skill value
g_time_rwis <- rank_time %>%
  dplyr::filter(horizon == 14) %>%
  dplyr::left_join(tb_main, by = "model") %>%
  dplyr::mutate(label = ordered(label, main_model_labels)) %>%
  ggplot(aes(x = forecast_from, y = rwis, col = label)) +
  geom_bump(lwd = 0.8) +
  geom_point(size = 2) +
  scale_x_date(breaks = plot_dates[seq(2, length(plot_dates), 4)], date_labels = "%d %b %y",
               limits = c(as.Date("2020-10-01"), as.Date("2021-05-02"))) +
  scale_y_continuous() +
  color_models +
  labs(x = "", y = "Relative WIS",
       title = "A",
       col = "Model") +
  theme_bw() +
  theme(legend.position = "top") +
  theme(text = element_text(size = fig_text_size)) +
  guides(col = guide_legend(nrow=1, byrow=TRUE))
  
# Mean AE
g_time_mae <- mae_time %>%
  dplyr::filter(horizon == 14) %>%
  ggplot(aes(x = forecast_from, y = mae)) +
  geom_bump(aes(col = label), lwd = 0.8) +
  geom_point(aes(col = label), size = 2) +
  scale_x_date(breaks = plot_dates[seq(2, length(plot_dates), 4)], date_labels = "%d %b %y",
               limits = c(as.Date("2020-10-01"), as.Date("2021-05-02"))) +
  color_models +
  labs(x = "Forecast date", y = "MAE",
       title = "B",
       col = "Model") +
  theme_bw() +
  theme(legend.position = "none") +
  theme(text = element_text(size = fig_text_size)) +
  guides(col = guide_legend(nrow = 1, byrow = TRUE))

#####

g_figure_s5 <- guide_area() /
  g_time_rwis /
  g_time_mae /
  g_time_obs +
  plot_layout(guides = "collect", heights = c(0.2, 1, 1, 1))

ggsave(plot = g_figure_s5,
       filename = here::here("data", "out", "figures", "figure_s5.png"),
       width = 14, height = 8, units = "in",
       dpi = 500)

#####

```


## By Trust

```{r}

# Pairwise comparison
rank_trust <- eval_pipeline(raw_scores = adm_scores,
                           models = main_models,
                           summarise_by = c("id", "horizon", "model"))

mae_trust <- adm_scores %>%
  dplyr::filter(model %in% main_models) %>%
  dplyr::group_by(horizon, id, model) %>%
  dplyr::summarise(av_aem = mean(aem, na.rm = TRUE)) %>%
  dplyr::left_join(rank_trust, by = c("horizon", "id", "model")) %>%
  dplyr::mutate(model = ordered(model, main_models)) %>%
  dplyr::group_by(horizon, id) %>%
  dplyr::mutate(rank1_ae = min(av_aem[which(rank == 1)]),
                meanensemble_ae = av_aem[which(model == "mean_ensemble_forecast")]) %>%
  dplyr::ungroup()

```

### In-text values
```{r}

# % times outperforming baseline (sWIS < 1)
rank_trust %>%
  dplyr::group_by(horizon, model) %>%
  dplyr::summarise(n_tot = n(),
                   n = sum(swis < 1)) %>%
  dplyr::mutate(p = n/n_tot) %>%
  dplyr::arrange(horizon, model)

# median/IQR rWIS
rank_trust %>%
  dplyr::group_by(horizon, model) %>%
  dplyr::summarise(med_rwis = median(rwis),
                   iq1_rwis = quantile(rwis, 0.25),
                   iq3_rwis = quantile(rwis, 0.75)) %>%
  dplyr::mutate(iqr = iq3_rwis - iq1_rwis) %>%
  dplyr::arrange(horizon, model)

# % times ranking first/second
rank_trust %>%
  dplyr::group_by(horizon, model, rank) %>%
  dplyr::summarise(n = n()) %>%
  tidyr::pivot_wider(names_from = model, values_from = n) %>%
  dplyr::arrange(horizon, rank)

```


### Figure 4
```{r}

g_location_scatter <- rank_trust %>%
  dplyr::filter(horizon == 7,
                model != "baseline") %>%
  dplyr::select(id, model, rwis) %>%
  dplyr::left_join(rank_trust %>%
                     dplyr::filter(horizon == 7,
                                   model == "baseline") %>%
                     dplyr::select(id, baseline = rwis),
                   by = "id") %>%
  dplyr::left_join(tb_main) %>%
  dplyr::mutate(model = ordered(label, main_model_labels)) %>%
  ggplot() +
  geom_abline(slope = 1, intercept = 0, lty = 2, lwd = 0.8, col = "grey50") +
  geom_point(aes(x = baseline, y = rwis, col = model), size = 2, alpha = 0.2) +
  geom_rug(aes(x = baseline, y = rwis), alpha = 0.2) +
  facet_wrap(. ~ model) +
  scale_x_continuous(breaks = seq(0, 2, 0.2)) +
  scale_y_continuous(breaks = seq(0, 2, 0.2)) +
  scale_color_brewer(palette = "Set2") +
  scale_fill_brewer(palette = "Set2") +
  labs(y = "Model rWIS", x = "Baseline rWIS",
       title = "A") +
  theme_bw() +
  theme(legend.position = "none") +
  theme(text = element_text(size = fig_text_size))

# Distribution of ranks
g_location_rank <- rank_trust %>%
  dplyr::filter(horizon == 7) %>%
  dplyr::group_by(model, rank) %>%
  dplyr::summarise(n = n()) %>%
  dplyr::mutate(p = n/sum(n),
                rank = as.character(rank)) %>%
  dplyr::left_join(tb_main, by = "model") %>%
  dplyr::mutate(label = ordered(label, rev(main_model_labels))) %>%
  ggplot(aes(y = label, x = p, fill = rank)) +
  geom_col() +
  scale_x_continuous(breaks = seq(0, 1, 0.2)) +
  scale_fill_brewer(palette = "Greens", direction = -1) +
  labs(x = "Proportion of Trusts", y  = "",
       title = "B",
       fill = "Rank") +
  theme_bw() +
  theme(text = element_text(size = fig_text_size))

g_location_scattermae <- mae_trust %>%
  dplyr::filter(horizon == 7,
                model != "baseline") %>%
  dplyr::select(id, model, av_aem) %>%
  dplyr::left_join(mae_trust %>%
                     dplyr::filter(horizon == 7,
                                   model == "baseline") %>%
                     dplyr::select(id, baseline = av_aem),
                   by = "id") %>%
  dplyr::left_join(tb_main) %>%
  dplyr::mutate(model = ordered(label, main_model_labels)) %>%
  ggplot() +
  geom_abline(slope = 1, intercept = 0, lty = 2, lwd = 0.8, col = "grey50") +
  geom_point(aes(x = baseline, y = av_aem, col = model), size = 2, alpha = 0.2) +
  geom_rug(aes(x = baseline, y = av_aem), alpha = 0.4) +
  facet_wrap(. ~ model) +
  scale_x_continuous(breaks = seq(0, 20, 5)) +
  scale_y_continuous(breaks = seq(0, 20, 5)) +
  scale_color_brewer(palette = "Set2") +
  scale_fill_brewer(palette = "Set2") +
  labs(y = "Model MAE", x = "Baseline MAE",
       title = "C") +
  theme_bw() +
  theme(legend.position = "none") +
  theme(text = element_text(size = fig_text_size))

#####

g_figure_4 <- (g_location_scatter + g_location_scattermae) /
  (g_location_rank + plot_layout(guides = "keep")) +
  plot_layout(heights = c(3, 1.5), guides = "collect")

ggsave(plot = g_figure_4,
       filename = here::here("data", "out", "figures", "figure_4.png"),
       width = 14, height = 10, units = "in",
       dpi = 500)

ggsave(plot = g_figure_4,
       filename = here::here("data", "out", "figures", "figure_4.pdf"),
       width = 14, height = 10, units = "in",
       dpi = 500)

#####

```

### Figure S6
```{r}

g_location_scatter <- rank_trust %>%
  dplyr::filter(horizon == 14,
                model != "baseline") %>%
  dplyr::select(id, model, rwis) %>%
  dplyr::left_join(rank_trust %>%
                     dplyr::filter(horizon == 14,
                                   model == "baseline") %>%
                     dplyr::select(id, baseline = rwis),
                   by = "id") %>%
  dplyr::left_join(tb_main) %>%
  dplyr::mutate(model = ordered(label, main_model_labels)) %>%
  ggplot() +
  geom_abline(slope = 1, intercept = 0, lty = 2, lwd = 0.8, col = "grey50") +
  geom_point(aes(x = baseline, y = rwis, col = model), size = 2, alpha = 0.2) +
  geom_rug(aes(x = baseline, y = rwis), alpha = 0.4) +
  facet_wrap(. ~ model) +
  scale_x_continuous(breaks = seq(0, 3, 0.4)) +
  scale_y_continuous(breaks = seq(0, 3, 0.4)) +
  scale_color_brewer(palette = "Set2") +
  scale_fill_brewer(palette = "Set2") +
  labs(y = "Model rWIS", x = "Baseline rWIS",
       title = "A") +
  theme_bw() +
  theme(legend.position = "none") +
  theme(text = element_text(size = fig_text_size))

# Distribution of ranks
g_location_rank <- rank_trust %>%
  dplyr::filter(horizon == 14) %>%
  dplyr::group_by(model, rank) %>%
  dplyr::summarise(n = n()) %>%
  dplyr::mutate(p = n/sum(n),
                rank = as.character(rank)) %>%
  dplyr::left_join(tb_main, by = "model") %>%
  dplyr::mutate(label = ordered(label, rev(main_model_labels))) %>%
  ggplot(aes(y = label, x = p, fill = rank)) +
  geom_col() +
  scale_x_continuous(breaks = seq(0, 1, 0.2)) +
  scale_fill_brewer(palette = "Greens", direction = -1) +
  labs(x = "Proportion of Trusts", y  = "",
       title = "B",
       fill = "Rank") +
  theme_bw() +
  theme(text = element_text(size = fig_text_size))

g_location_scattermae <- mae_trust %>%
  dplyr::filter(horizon == 14,
                model != "baseline") %>%
  dplyr::select(id, model, av_aem) %>%
  dplyr::left_join(mae_trust %>%
                     dplyr::filter(horizon == 14,
                                   model == "baseline") %>%
                     dplyr::select(id, baseline = av_aem),
                   by = "id") %>%
  dplyr::left_join(tb_main) %>%
  dplyr::mutate(model = ordered(label, main_model_labels)) %>%
  ggplot() +
  geom_abline(slope = 1, intercept = 0, lty = 2, lwd = 0.8, col = "grey50") +
  geom_point(aes(x = baseline, y = av_aem, col = model), size = 2, alpha = 0.2) +
  geom_rug(aes(x = baseline, y = av_aem), alpha = 0.4) +
  facet_wrap(. ~ model) +
  scale_x_continuous(trans = "log2") +
  scale_y_continuous(trans = "log2") +
  scale_color_brewer(palette = "Set2") +
  scale_fill_brewer(palette = "Set2") +
  labs(y = "Model MAE", x = "Baseline MAE",
       title = "C") +
  theme_bw() +
  theme(legend.position = "none") +
  theme(text = element_text(size = fig_text_size))


#####

g_figure_s6 <- (g_location_scatter | g_location_scattermae) /
  (g_location_rank + plot_layout(guides = "keep")) +
  plot_layout(heights = c(3, 1.5), guides = "collect")

ggsave(plot = g_figure_s6,
       filename = here::here("data", "out", "figures", "figure_s6.png"),
       width = 14, height = 10, units = "in",
       dpi = 500)

#####

```


## Value of perfect forecasts

```{r}

# Pairwise comparison
## By horizon
rank_obs_horizon <- eval_pipeline(raw_scores = adm_scores,
                                  models = obs_models,
                                  summarise_by = c("horizon", "model"))
## By forecast date
rank_obs_time <- eval_pipeline(raw_scores = adm_scores,
                               models = obs_models,
                               summarise_by = c("forecast_from", "horizon", "model"))
## By Trust
rank_obs_trust <- eval_pipeline(raw_scores = adm_scores,
                                models = obs_models,
                                summarise_by = c("id", "horizon", "model"))
## All scenarios
# rank_obs_all <- eval_pipeline(raw_scores = adm_scores,
#                               models = obs_models,
#                               summarise_by = c("horizon", "forecast_from", "id", "model"))
# saveRDS(object = rank_obs_all,
#         file = here::here(score_dir, "pairwise_observed.rds"))
rank_obs_all <- readRDS(file = here::here(score_dir, "pairwise_observed.rds"))

# Comparing to models using forecast future COVID-19 cases
compare_horizon <- rank_horizon %>%
  dplyr::select(horizon, model_for = model, wis_for = swis) %>%
  dplyr::left_join(tb_main,
                   by = c("model_for" = "model")) %>%
  dplyr::left_join(tb_obs,
                   by = "label")  %>%
  dplyr::left_join(rank_obs_horizon %>%
                     dplyr::select(horizon, model, wis_obs = swis),
                   by = c("horizon", "model")) %>%
  dplyr::select(horizon, label, wis_for, wis_obs) %>%
  dplyr::mutate(label = ordered(label, main_model_labels),
                wis_for = round(wis_for, 2),
                wis_obs = round(wis_obs, 2))

compare_time <- rank_time %>%
  dplyr::select(horizon, forecast_from, model_for = model, wis_for = swis) %>%
  dplyr::left_join(tb_main,
                   by = c("model_for" = "model")) %>%
  dplyr::left_join(tb_obs,
                   by = "label")  %>%
  dplyr::left_join(rank_obs_time %>%
                     dplyr::select(horizon, forecast_from, model, wis_obs = swis),
                   by = c("horizon", "forecast_from", "model")) %>%
  dplyr::select(horizon, forecast_from, label, wis_for, wis_obs) %>%
  dplyr::mutate(label = ordered(label, main_model_labels),
                wis_for = round(wis_for, 2),
                wis_obs = round(wis_obs, 2))

compare_trust <- rank_trust %>%
  dplyr::select(horizon, id, model_for = model, wis_for = swis) %>%
  dplyr::left_join(tb_main,
                   by = c("model_for" = "model")) %>%
  dplyr::left_join(tb_obs,
                   by = "label")  %>%
  dplyr::left_join(rank_obs_trust %>%
                     dplyr::select(horizon, id, model, wis_obs = swis),
                   by = c("horizon", "id", "model")) %>%
  dplyr::select(horizon, id, label, wis_for, wis_obs) %>%
  dplyr::mutate(label = ordered(label, main_model_labels),
                wis_for = round(wis_for, 2),
                wis_obs = round(wis_obs, 2))

```

### In-text values
```{r value of data text values}

# All scenarios
rank_obs_all %>%
  dplyr::group_by(model) %>%
  dplyr::summarise(n_tot = n(),
                   n = sum(swis < 1, na.rm = TRUE)) %>%
  dplyr::mutate(p = n/n_tot) %>%
  dplyr::arrange(model)

# By forecast date
## Outperforming baseline
compare_time %>%
  dplyr::filter(grepl("Convolution", label) |
                  grepl("ARIMA", label) & horizon == 14) %>%
  dplyr::group_by(horizon, label) %>%
  dplyr::summarise(n_tot = n(),
                   n_forecast = sum(wis_for < 1),
                   n_observed = sum(wis_obs < 1)) %>%
  dplyr::arrange(label, horizon)
## Decrease sWIS ARIMA
compare_time %>%
  dplyr::filter(grepl("ARIMA", label),
                horizon == 14,
                forecast_from %in% c(as.Date("2020-12-13"),
                                     as.Date("2021-01-03")))


# By Trust
## Outperforming baseline
compare_trust %>%
  dplyr::filter(grepl("Convolution", label) |
                  grepl("ARIMA", label) & horizon == 14) %>%
  dplyr::group_by(horizon, label) %>%
  dplyr::summarise(n_tot = n(),
                   n_forecast = sum(wis_for < 1),
                   n_observed = sum(wis_obs < 1)) %>%
  dplyr::arrange(label, horizon)
## Improved sWIS
compare_trust %>%
  dplyr::filter(grepl("Convolution", label) |
                  grepl("ARIMA", label) & horizon == 14) %>%
  dplyr::group_by(horizon, label) %>%
  dplyr::summarise(n_tot = n(),
                   n_improve = sum(wis_obs < wis_for))
## Bad Trusts
compare_trust %>%
  dplyr::filter(grepl("Convolution", label) |
                  grepl("ARIMA", label) & horizon == 14) %>%
  dplyr::filter(wis_for > 1,
                wis_for < wis_obs) %>%
  dplyr::left_join(trust_names, by = c("id" = "trust_code"))

```

### Table S4
```{r}

compare_horizon %>%
  dplyr::arrange(horizon, label) %>%
  kableExtra::kbl() %>%
  kableExtra::kable_styling()

```

### Figure S7
```{r}

g_value_arima_time <- compare_time %>%
  dplyr::filter(horizon == 14,
                grepl("ARIMA", label)) %>%
  pivot_longer(cols = contains("wis"), names_to = "model") %>%
  dplyr::mutate(model = ifelse(grepl("obs", model), "Observed", "Forecast")) %>%
  ggplot(aes(x = forecast_from, y = value, lty = model)) +
  geom_hline(yintercept = 1, lty = 2, lwd = 0.6, col = "grey50") +
  geom_bump(col = "#FC8D62", lwd = 0.8) +
  geom_point(col = "#FC8D62", size = 2) +
  facet_wrap(paste0(horizon, "-day forecast horizon") ~ .) +
  scale_x_date(breaks = plot_dates[seq(2, length(plot_dates), 4)], date_labels = "%d %b",
               limits = c(as.Date("2020-10-01"), as.Date("2021-05-01"))) +
  scale_color_brewer(palette = "Set2") +
  labs(x = "Forecast date", y = "Scaled WIS",
       title = "A",
       lty = "Future\ncases") +
  theme_bw() +
  theme(legend.position = "top",
        text = element_text(size = fig_text_size))

g_value_arima_trust <- compare_trust %>%
  dplyr::filter(horizon == 14,
                grepl("ARIMA", label)) %>%
  ggplot(aes(x = wis_for, y = wis_obs)) +
  geom_abline(slope = 1, intercept = 0, lty = 2, col = "grey50", lwd = 0.6) +
  geom_point(col = "#FC8D62", size = 3, alpha = 0.6) +
  geom_rug() +
  facet_wrap(paste0(horizon, "-day forecast horizon") ~ .) +
  labs(x = "sWIS ARIMA regression, forecast cases",
       y = "sWIS ARIMA regression,\nobserved cases",
       title = "B") +
  theme_bw() +
  theme(text = element_text(size = fig_text_size))

g_value_convolution_time <- compare_time %>%
  dplyr::filter(grepl("Convolution", label)) %>%
  pivot_longer(cols = contains("wis"), names_to = "model") %>%
  dplyr::mutate(model = ifelse(grepl("obs", model), "Observed", "Forecast"),
                horizon = paste0(horizon, "-day horizon"),
                horizon = ordered(horizon, c("7-day horizon", "14-day horizon"))) %>%
  ggplot(aes(x = forecast_from, y = value, lty = model)) +
  geom_hline(yintercept = 1, lty = 2, lwd = 0.6, col = "grey50") +
  geom_bump(col = "#8DA0CB", lwd = 0.8) +
  geom_point(col = "#8DA0CB", size = 2) +
  facet_wrap(horizon ~ ., ncol = 1, scales = "free_y") +
  scale_x_date(breaks = plot_dates[seq(2, length(plot_dates), 4)], date_labels = "%d %b",
               limits = c(as.Date("2020-10-01"), as.Date("2021-05-01"))) +
  scale_color_brewer(palette = "Set2") +
  labs(x = "Forecast date", y = "Scaled WIS",
       title = "C",
       lty = "Future\ncases") +
  theme_bw() +
  theme(legend.position = "top",
        text = element_text(size = fig_text_size))

g_value_convolution_trust <- compare_trust %>%
  dplyr::filter(grepl("Convolution", label)) %>%
  dplyr::mutate(horizon = paste0(horizon, "-day horizon"),
                horizon = ordered(horizon, c("7-day horizon", "14-day horizon"))) %>%
  ggplot(aes(x = wis_for, y = wis_obs)) +
  geom_abline(slope = 1, intercept = 0, lty = 2, col = "grey50", lwd = 0.6) +
  geom_point(col = "#8DA0CB", size = 3, alpha = 0.5) +
  geom_rug() +
  facet_wrap(horizon ~ ., ncol = 1, scales = "free") +
  labs(x = "sWIS Convolution, forecast cases",
       y = "sWIS Convolution,\nobserved cases",
       title = "D") +
  theme_bw() +
  theme(text = element_text(size = fig_text_size))


#####

g_fig_s7 <- (g_value_arima_time | g_value_arima_trust) /
  (g_value_convolution_time | g_value_convolution_trust) +
  plot_layout(heights = c(1, 2))

ggsave(plot = g_fig_s7,
       filename = here::here("data", "out", "figures", "figure_s7.png"),
       width = 14, height = 8, units = "in",
       dpi = 500)

#####

```

### Figures S8 and S9
```{r}

# Calibration
g_value_calibration <- emp_coverage %>%
  dplyr::filter(model %in% obs_models) %>% 
  dplyr::left_join(tb_obs, by = "model") %>%
  dplyr::mutate(label = ordered(label, main_model_labels)) %>%
  ggplot(aes(x = horizon, y = value, col = label)) +
  geom_line(lwd = 0.6) +
  geom_point(size = 2) +
  geom_hline(aes(yintercept = truth), lty = 2) +
  facet_grid(name ~ .) +
  scale_x_continuous(breaks = seq(2, 14, 2)) +
  scale_y_continuous(limits = c(NA, 1), breaks = seq(0, 1, 0.2)) +
  color_models +
  labs(x = "Forecast horizon (days)",
       y = "Empirical coverage",
       title = "A",
       col = "Model") +
  theme_bw() +
  theme(legend.position = "top") +
  theme(text = element_text(size = fig_text_size)) +
  guides(col = guide_legend(nrow=1, byrow=TRUE))

g_value_horizon <- rank_obs_horizon %>%
  dplyr::left_join(tb_obs, by = "model") %>%
  dplyr::group_by(horizon) %>%
  dplyr::mutate(label = ordered(label, rev(main_model_labels)),
                horizon = as.character(horizon),
                horizon = ordered(horizon, c("7", "14"))) %>%
  ggplot(aes(y = label, x = rwis, col = horizon)) +
  geom_point(size = 4) +
  scale_color_brewer(palette = "Paired") +
  labs(x = "Relative WIS", y = "",
       title = "B",
       col = "Horizon (days)") +
  theme_bw() +
  theme(legend.position = "top") +
  theme(text = element_text(size = fig_text_size))

# Distribution of all-scenario ranks
g_value_rwisrank <- rank_obs_all %>%
  dplyr::group_by(model, rank) %>%
  dplyr::summarise(n = n()) %>%
  dplyr::mutate(p = n/sum(n),
                rank = as.character(rank),
                model = ordered(model, obs_models)) %>%
  dplyr::left_join(tb_obs, by = "model") %>%
  dplyr::mutate(label = ordered(label, rev(main_model_labels))) %>%
  ggplot(aes(y = label, x = p, fill = rank)) +
  geom_col() +
  scale_x_continuous(breaks = seq(0, 1, 0.2)) +
  scale_fill_brewer(palette = "Reds", direction = -1) +
  labs(x = "Proportion of all scenarios", y  = "",
       title = "C",
       fill = "Rank") +
  theme_bw() +
  theme(legend.position = "top",
        text = element_text(size = fig_text_size)) +
  guides(col = guide_legend(nrow=1, byrow=TRUE))

# rWIS by forecast date
g_value_time7 <- rank_obs_time %>%
  dplyr::filter(horizon == 7) %>%
  dplyr::mutate(model = ordered(model, obs_models)) %>%
  dplyr::left_join(tb_obs, by = "model") %>%
  dplyr::mutate(label = ordered(label, main_model_labels)) %>%
  ggplot(aes(x = forecast_from, y = rwis, col = label)) +
  geom_bump(lwd = 0.8) +
  geom_point(size = 2) +
  # facet_grid(model ~ .) +
  scale_x_date(breaks = plot_dates[seq(2, length(plot_dates), 8)], date_labels = "%d %b %y",
               limits = c(as.Date("2020-10-01"), as.Date("2021-05-01"))) +
  scale_y_continuous(limits = c(0.5, 2.4), breaks = seq(0, 3, 0.4)) +
  color_models +
  labs(x = "Forecast date", y = "Relative WIS",
       title = "A",
       col = "Model") +
  theme_bw() +
  theme(legend.position = "top") +
  theme(text = element_text(size = fig_text_size)) +
  guides(col = guide_legend(nrow=1, byrow=TRUE))

g_value_time14 <- rank_obs_time %>%
  dplyr::filter(horizon == 14) %>%
  dplyr::mutate(model = ordered(model, obs_models)) %>%
  dplyr::left_join(tb_obs, by = "model") %>%
  dplyr::mutate(label = ordered(label, main_model_labels)) %>%
  ggplot(aes(x = forecast_from, y = rwis, col = label)) +
  geom_bump(lwd = 0.8) +
  geom_point(size = 2) +
  scale_x_date(breaks = plot_dates[seq(2, length(plot_dates), 8)], date_labels = "%d %b %y",
               limits = c(as.Date("2020-10-01"), as.Date("2021-05-01"))) +
  scale_y_continuous(limits = c(0.5, 2.4), breaks = seq(0, 3, 0.4)) +
  color_models +
  labs(x = "Forecast date", y = "Relative WIS",
       title = "B",
       col = "Model") +
  theme_bw() +
  theme(legend.position = "top") +
  theme(text = element_text(size = fig_text_size)) +
  guides(col = guide_legend(nrow=1, byrow=TRUE))

g_value_trust7 <- rank_obs_trust %>%
  dplyr::filter(horizon == 7,
                model != "baseline") %>%
  dplyr::select(id, model, rwis) %>%
  dplyr::left_join(rank_obs_trust %>%
                     dplyr::filter(horizon == 7,
                                   model == "baseline") %>%
                     dplyr::select(id, baseline = rwis),
                   by = "id") %>%
  dplyr::left_join(tb_obs) %>%
  dplyr::mutate(model = ordered(label, main_model_labels)) %>%
  ggplot() +
  geom_abline(slope = 1, intercept = 0, lty = 2, lwd = 0.8, col = "grey50") +
  geom_point(aes(x = baseline, y = rwis, col = model), size = 2, alpha = 0.2) +
  geom_rug(aes(x = baseline, y = rwis), alpha = 0.2) +
  facet_wrap(. ~ model) +
  # scale_x_continuous(trans = "log2", limits = c(NA, 8), breaks = c(0.5, 1, 2, 4, 8)) +
  scale_color_brewer(palette = "Set2") +
  scale_fill_brewer(palette = "Set2") +
  labs(y = "Model rWIS", x = "Baseline rWIS",
       title = "C") +
  theme_bw() +
  theme(legend.position = "none") +
  theme(text = element_text(size = fig_text_size)) +
  guides(col = guide_legend(nrow=1, byrow=TRUE))

g_value_trust14 <- rank_obs_trust %>%
  dplyr::filter(horizon == 14,
                model != "baseline") %>%
  dplyr::select(id, model, rwis) %>%
  dplyr::left_join(rank_obs_trust %>%
                     dplyr::filter(horizon == 7,
                                   model == "baseline") %>%
                     dplyr::select(id, baseline = rwis),
                   by = "id") %>%
  dplyr::left_join(tb_obs) %>%
  dplyr::mutate(model = ordered(label, main_model_labels)) %>%
  ggplot() +
  geom_abline(slope = 1, intercept = 0, lty = 2, lwd = 0.8, col = "grey50") +
  geom_point(aes(x = baseline, y = rwis, col = model), size = 2, alpha = 0.2) +
  geom_rug(aes(x = baseline, y = rwis), alpha = 0.2) +
  facet_wrap(. ~ model) +
  scale_color_brewer(palette = "Set2") +
  scale_fill_brewer(palette = "Set2") +
  labs(y = "Model rWIS", x = "Baseline rWIS",
       title = "D") +
  theme_bw() +
  theme(legend.position = "none") +
  theme(text = element_text(size = fig_text_size)) +
  guides(col = guide_legend(nrow=1, byrow=TRUE))

#####

g_fig_s8 <- ((g_value_calibration | (g_value_horizon + plot_layout(guides = "keep"))) /
     g_value_rwisrank + plot_layout(guides = "keep"))

ggsave(plot = g_fig_s8,
       filename = here::here("data", "out", "figures", "figure_s8.png"),
       width = 14, height = 8, units = "in",
       dpi = 500)

g_fig_s9 <- guide_area() /
  (g_value_time7 | g_value_time14) /
  (g_value_trust7 | g_value_trust14) +
  plot_layout(heights = c(0.2, 1, 1), guides = "collect")

ggsave(plot = g_fig_s9,
       filename = here::here("data", "out", "figures", "figure_s9.png"),
       width = 14, height = 8, units = "in",
       dpi = 500)

#####

```


# Supplementary text

## Time series ensemble
```{r}

tsensemble_models <- c("baseline",
                       "arima",
                       "ets",
                       "tsensemble_ae",
                       "tsensemble_aez")

# By horizon
rank_tsensemble_horizon <- eval_pipeline(raw_scores = adm_scores,
                           models = tsensemble_models,
                           summarise_by = c("horizon", "model"))

```

### Table S1
```{r}

rank_tsensemble_horizon %>%
  dplyr::mutate(model = ordered(model, tsensemble_models),
                rwis = round(rwis, 2),
                swis = round(swis, 2)) %>%
  dplyr::arrange(horizon, model) %>%
  kableExtra::kbl() %>%
  kableExtra::kable_styling()

```

## ARIMA regression
```{r}

arimareg_models <- c("baseline",
                     unique(adm_scores$model)[grepl("arimareg", unique(adm_scores$model)) & 
                                                      grepl("forecast", unique(adm_scores$model))])

# By horizon
rank_arimareg_horizon <- eval_pipeline(raw_scores = adm_scores,
                                       models = arimareg_models,
                                       summarise_by = c("horizon", "model")) %>%
  dplyr::mutate(lag = stringr::str_remove(model, "arimareg_"),
                lag = stringr::str_remove(lag, "_forecast"),
                lag = as.numeric(lag))
                                                
```

### Table S2
```{r}

rank_arimareg_horizon %>%
  dplyr::select(horizon, lag, rwis, swis, rank) %>%
  dplyr::mutate(rwis = round(rwis, 2),
                swis = round(swis, 2)) %>%
  dplyr::arrange(horizon, lag) %>%
  kableExtra::kbl() %>%
  kableExtra::kable_styling()

```


